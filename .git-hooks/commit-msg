#!/usr/bin/env bash
set -euo pipefail

MSG_FILE="$1"
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Enforce commit message contains story id when on story/* branch
if [[ "$BRANCH" =~ ^story/ ]]; then
  STORY_ID=$(printf '%s' "$BRANCH" | sed -E 's#^story/([0-9]+(\.[0-9]+)*)-.*#\1#')
  MSG=$(tr '[:upper:]' '[:lower:]' < "$MSG_FILE")
  if ! printf '%s' "$MSG" | grep -E -q "story[[:space:]/:-]*${STORY_ID}"; then
    echo "[commit-msg] ERROR: Commit message must reference story ${STORY_ID} (e.g., 'story ${STORY_ID}: <message>')" >&2
    exit 1
  fi
fi

exit 0



name: Branch Protection Sync

on:
  workflow_dispatch:
  schedule:
    # Run daily at 6 AM UTC to ensure branch protection stays in sync
    - cron: '0 6 * * *'
  push:
    branches:
      - develop
    paths:
      - '.github/workflows/**'

permissions:
  contents: read
  actions: read

jobs:
  sync-protection:
    name: Sync Branch Protection Rules
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Sync branch protection contexts with actual workflow names
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          echo "::group::Analyzing required contexts from workflows"

          # Extract required contexts from our actual workflows
          REQUIRED_CONTEXTS=(
            "QA Gate / qa-approved"      # From qa-gate.yml
            "build-and-test"            # From flutter-ci.yml
            "pr-lint"                   # From pr-lint.yml
            "lint"                      # From workflow-lint.yml
          )

          echo "Expected required contexts:"
          printf ' - %s\n' "${REQUIRED_CONTEXTS[@]}"

          # Get current branch protection settings
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          echo "::group::Checking current branch protection"
          CURRENT=$(gh api repos/"${OWNER}"/"${REPO}"/branches/develop/protection/required_status_checks --jq '.contexts')
          echo "Current contexts: $CURRENT"

          # Build the new contexts JSON array
          NEW_CONTEXTS_JSON=$(printf '%s\n' "${REQUIRED_CONTEXTS[@]}" | jq -R . | jq -s .)
          echo "New contexts JSON: $NEW_CONTEXTS_JSON"

          # Compare and update if different
          if [[ "$CURRENT" != "$NEW_CONTEXTS_JSON" ]]; then
            echo "::group::Updating branch protection contexts"
            echo '{"strict":true,"contexts":'$NEW_CONTEXTS_JSON'}' | \
              gh api repos/"${OWNER}"/"${REPO}"/branches/develop/protection/required_status_checks \
              -X PATCH --input -
            echo "✅ Branch protection contexts updated successfully"
          else
            echo "✅ Branch protection contexts are already in sync"
          fi

          echo "::group::Validation"
          UPDATED=$(gh api repos/"${OWNER}"/"${REPO}"/branches/develop/protection/required_status_checks --jq '.contexts')
          echo "Final contexts: $UPDATED"
          echo "::endgroup::"

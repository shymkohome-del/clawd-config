name: Enforce Required Checks (Workflow Lint)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/workflow-lint.yml"
      - ".github/workflows/enforce-required-checks.yml"
      - ".github/workflows/auto-pr-from-qa.yml"
  schedule:
    - cron: "0 6 * * 1"  # Weekly on Mondays 06:00 UTC

permissions:
  contents: read

jobs:
  enforce:
    runs-on: ubuntu-latest
    env:
      OWNER: ${{ github.repository_owner }}
      REPO: ${{ github.event.repository.name || github.repository }}
      REQUIRED_CONTEXTS: '["build-and-test","pr-lint","lint"]'
    steps:
      - name: Common setup
        uses: ./.github/actions/common-setup
      - name: Show context
        shell: bash
        run: |
          set -euo pipefail
          echo "Repo: ${GITHUB_REPOSITORY}"
          echo "Owner: ${OWNER}"
          echo "Required contexts: ${REQUIRED_CONTEXTS}"

      - name: Verify admin token presence
        id: token
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ secrets.REPO_ADMIN_TOKEN || '' }}" ]]; then
            echo "has_token=false" >> "$GITHUB_OUTPUT"
            echo "No REPO_ADMIN_TOKEN secret present. Will skip enforcement and only emit guidance."
          else
            echo "has_token=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Emit guidance when token missing
        if: steps.token.outputs.has_token == 'false'
        shell: bash
        run: |
          set -euo pipefail
          echo "Required check enforcement is automated but needs a repository admin token once per repo."
          echo
          echo "Action (one-time by repo admin):"
          echo "- Create a fine-grained PAT with Repository administration: Read and write"
          echo "- Add it as repo secret: REPO_ADMIN_TOKEN"
          echo "- Re-run this workflow (workflow_dispatch)"
          echo
          echo "This will configure branch protection to require these status checks on main/develop:"
          echo "- Workflow Lint / lint"
          echo "- Auto PR and Auto-merge on QA Done / Workflow Lint"

      - name: Enforce required checks for branches
        if: steps.token.outputs.has_token == 'true'
        env:
          API: https://api.github.com
          TOKEN: ${{ secrets.REPO_ADMIN_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          # Resolve repo name if github.event.repository.name is unavailable (e.g., for workflow_run)
          if [[ "$REPO" == */* ]]; then
            REPO_NAME="${REPO#*/}"
          else
            REPO_NAME="$REPO"
          fi

          # Required contexts JSON array from env (must be valid JSON)
          REQUIRED_CONTEXTS_JSON="${REQUIRED_CONTEXTS}"

          enforce_for_branch() {
            local BRANCH="$1"
            echo ""
            echo ">>> Enforcing required checks on branch: ${BRANCH}"

            # Fetch existing protection (if any)
            PROTECTION=$(curl -sS -H "authorization: Bearer ${TOKEN}" -H "accept: application/vnd.github+json" \
              "$API/repos/$OWNER/$REPO_NAME/branches/$BRANCH/protection" || true)

            # Extract current contexts if present; default to empty array
            CURRENT_CONTEXTS=$(printf '%s' "$PROTECTION" | jq -c '.required_status_checks.contexts // []')

            # Replace existing contexts with the required set (prune legacy names)
            UPDATED_CONTEXTS=$(jq -nc --argjson req "$REQUIRED_CONTEXTS_JSON" '$req')

            # Build payload: preserve strict=true, set contexts; keep other settings permissive
            PAYLOAD=$(jq -nc --argjson contexts "$UPDATED_CONTEXTS" '{
              required_status_checks: { strict: true, contexts: $contexts },
              enforce_admins: true,
              required_pull_request_reviews: null,
              restrictions: null
            }')

            # PUT protection
            RESP=$(curl -sS -X PUT -H "authorization: Bearer ${TOKEN}" -H "accept: application/vnd.github+json" \
              -H "content-type: application/json" -d "$PAYLOAD" \
              "$API/repos/$OWNER/$REPO_NAME/branches/$BRANCH/protection")

            echo "$RESP" | jq '.' || true

            # Verify all required contexts are present
            MISSING=$(printf '%s' "$RESP" | jq --argjson req "$REQUIRED_CONTEXTS_JSON" -e '
              (.required_status_checks.contexts // []) as $have | [ $req[] | select( . as $r | ( $have | index($r) ) == null ) ]') || true
            if [[ "$MISSING" != "[]" ]]; then
              echo "Failed to verify required check configuration for $BRANCH. Missing contexts: $MISSING" >&2
              exit 1
            fi
            echo "âœ“ Required contexts enforced on $BRANCH"
          }

          enforce_for_branch main || true
          enforce_for_branch develop || true

      - name: Summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "Enforcement job finished. See logs above for branch results."

name: Merge on Green (Fallback)

on:
  workflow_run:
    workflows: ["Flutter CI", "PR Lint", "Workflow Lint"]
    types: ["completed"]
  pull_request:
    types: [labeled, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  merge-on-green:
    if: ${{ vars.AUTO_MERGE_ENABLED != 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Prepare context
        id: ctx
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          # Pass potentially untrusted expressions via env vars per actionlint guidance
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref || '' }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha || '' }}
          WR_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch || '' }}
          WR_HEAD_SHA: ${{ github.event.workflow_run.head_sha || '' }}
        run: |
          set -euo pipefail
          echo "event_name=${EVENT_NAME}" >> "$GITHUB_OUTPUT"
          case "${EVENT_NAME}" in
            workflow_run)
              BRANCH="${WR_HEAD_BRANCH}"
              SHA="${WR_HEAD_SHA}"
              ;;
            pull_request)
              BRANCH="${PR_HEAD_REF}"
              SHA="${PR_HEAD_SHA}"
              ;;
            *)
              BRANCH="${GITHUB_REF_NAME:-}"
              SHA="${GITHUB_SHA:-}"
              ;;
          esac
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "sha=${SHA}" >> "$GITHUB_OUTPUT"

      - name: Find PR for branch
        id: find_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          BRANCH="${{ steps.ctx.outputs.branch }}"
          API="https://api.github.com"
          PR_NUMBER=$(curl -sS -H "authorization: Bearer ${GH_TOKEN}" -H "accept: application/vnd.github+json" \
            "${API}/repos/${OWNER}/${REPO}/pulls?head=${OWNER}:${BRANCH}&state=open" | jq '.[0].number // empty')
          if [[ -z "${PR_NUMBER}" ]]; then
            echo "No open PR found for ${BRANCH}. Skipping."
            exit 0
          fi
          echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Load PR details and gate by label/branch
        id: gate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          API="https://api.github.com"
          PR_NUMBER="${{ steps.find_pr.outputs.pr_number }}"
          PR=$(curl -sS -H "authorization: Bearer ${GH_TOKEN}" -H "accept: application/vnd.github+json" \
               "${API}/repos/${OWNER}/${REPO}/pulls/${PR_NUMBER}")
          HEAD_BRANCH=$(echo "$PR" | jq -r '.head.ref')
          LABELS=$(echo "$PR" | jq -r '[.labels[].name] | join(",")')
          MERGEABLE_STATE=$(echo "$PR" | jq -r '.mergeable_state')
          echo "head_branch=${HEAD_BRANCH}" >> "$GITHUB_OUTPUT"
          echo "labels=${LABELS}" >> "$GITHUB_OUTPUT"
          echo "mergeable_state=${MERGEABLE_STATE}" >> "$GITHUB_OUTPUT"
          if [[ "$HEAD_BRANCH" =~ ^story/ ]]; then
            if [[ ",${LABELS}," != *",automerge-ok,"* ]]; then
              echo "Story branch without 'automerge-ok' label. Skipping." 
              exit 0
            fi
          fi

      - name: Wait for required checks to be green (retry)
        id: wait_checks
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          API="https://api.github.com"
          PR_NUMBER="${{ steps.find_pr.outputs.pr_number }}"
          SHA="${{ steps.ctx.outputs.sha }}"
          # Candidate checks we care about; build required set dynamically based on presence
          CANDIDATE_CHECKS=(
            "Flutter CI / build-and-test"
            "PR Lint / pr-lint"
            "Workflow Lint / lint"
            "Auto PR and Auto-merge on QA Done / open-pr-and-automerge"
          )
          attempt=0; max_attempts=30
          while (( attempt < max_attempts )); do
            attempt=$((attempt+1))
            RESP=$(curl -sS -H "authorization: Bearer ${GH_TOKEN}" -H "accept: application/vnd.github+json" \
              "${API}/repos/${OWNER}/${REPO}/commits/${SHA}/check-runs")
            # Build required checks set based on which candidate checks exist on this commit
            REQ_CHECKS=()
            for NAME in "${CANDIDATE_CHECKS[@]}"; do
              if echo "$RESP" | jq -e --arg n "$NAME" '.check_runs[] | select(.name == $n)' >/dev/null; then
                REQ_CHECKS+=("$NAME")
              fi
            done
            if (( ${#REQ_CHECKS[@]} == 0 )); then
              echo "No matching check-runs found for this commit; proceeding as green by default."
              echo "checks_ok=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            ALL_OK=1
            for NAME in "${REQ_CHECKS[@]}"; do
              CONC=$(echo "$RESP" | jq -r --arg n "$NAME" '.check_runs[] | select(.name == $n) | .conclusion' | head -n1)
              if [[ -z "$CONC" || "$CONC" != "success" ]]; then
                ALL_OK=0
                break
              fi
            done
            if (( ALL_OK == 1 )); then
              echo "checks_ok=true" >> "$GITHUB_OUTPUT"
              echo "All required checks are green."
              exit 0
            fi
            sleep_secs=$(( 10 + attempt*5 ))
            echo "Checks not yet green. Attempt ${attempt}/${max_attempts}. Sleeping ${sleep_secs}s..."
            sleep ${sleep_secs}
          done
          echo "checks_ok=false" >> "$GITHUB_OUTPUT"
          echo "Timeout waiting for checks to pass. Skipping merge."
          exit 0

      - name: Merge PR (squash) and delete branch
        if: steps.wait_checks.outputs.checks_ok == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          API="https://api.github.com"
          PR_NUMBER="${{ steps.find_pr.outputs.pr_number }}"
          # Try merge
          MERGE_RESP=$(curl -sS -X PUT -H "authorization: Bearer ${GH_TOKEN}" -H "accept: application/vnd.github+json" \
            -d '{"merge_method":"squash"}' \
            "${API}/repos/${OWNER}/${REPO}/pulls/${PR_NUMBER}/merge")
          echo "$MERGE_RESP" | jq '.' || true
          if echo "$MERGE_RESP" | jq -e '.merged == true' >/dev/null; then
            echo "Merged PR #${PR_NUMBER} successfully."
          else
            echo "Merge did not occur (possibly already merged or not mergeable). Exiting gracefully."
            exit 0
          fi
          # Attempt branch deletion (safe if protected)
          HEAD_REF=$(curl -sS -H "authorization: Bearer ${GH_TOKEN}" -H "accept: application/vnd.github+json" \
            "${API}/repos/${OWNER}/${REPO}/pulls/${PR_NUMBER}" | jq -r '.head.ref')
          curl -sS -X DELETE -H "authorization: Bearer ${GH_TOKEN}" -H "accept: application/vnd.github+json" \
            "${API}/repos/${OWNER}/${REPO}/git/refs/heads/${HEAD_REF}" || true

      - name: Emit metrics summary
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.find_pr.outputs.pr_number || '' }}"
          MERGED_NOTE="${{ steps.wait_checks.outputs.checks_ok == 'true' && 'merge-attempted' || 'merge-skipped' }}"
          echo "### Merge-on-Green summary" >> $GITHUB_STEP_SUMMARY
          echo "- PR: #${PR_NUMBER}" >> $GITHUB_STEP_SUMMARY
          echo "- Checks green: ${{ steps.wait_checks.outputs.checks_ok }}" >> $GITHUB_STEP_SUMMARY
          echo "- Action: ${MERGED_NOTE}" >> $GITHUB_STEP_SUMMARY



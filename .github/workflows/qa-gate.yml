name: QA Gate

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, labeled, unlabeled]
    branches: [ develop ]

permissions:
  contents: read
  pull-requests: read

jobs:
  qa-approved:
    name: QA Gate / qa-approved
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check for qa:approved label
        shell: bash
        env:
          LABELS: ${{ join(github.event.pull_request.labels.*.name, ',') }}
          EVENT_ACTION: ${{ github.event.action }}
        run: |
          set -euo pipefail
          echo "Event: ${{ github.event_name }}"
          echo "Action: $EVENT_ACTION"
          echo "Labels: $LABELS"

          # For initial PR events, make this check informational only to avoid race conditions
          if [[ "$EVENT_ACTION" == "opened" ]] || [[ "$EVENT_ACTION" == "synchronize" ]] || [[ "$EVENT_ACTION" == "reopened" ]]; then
            if [[ ",${LABELS}," == *",qa:approved,"* ]]; then
              echo "✅ QA approved label present."
              exit 0
            else
              echo "⚠️  QA approval pending - this is normal for new PRs"
              echo "Available labels: $LABELS"
              echo "This check will be enforced when labels are applied or updated"
              exit 0
            fi
          fi

          # For label events and reviews, enforce the requirement strictly
          if [[ ",${LABELS}," == *",qa:approved,"* ]]; then
            echo "✅ QA approved label present."
            exit 0
          else
            echo "::error::Missing required QA approval label 'qa:approved'."
            echo "Available labels: $LABELS"
            echo "This PR cannot be merged without QA approval."
            exit 1
          fi

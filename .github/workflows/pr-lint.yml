name: PR Lint

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  push:
    branches:
      - 'story/**'

jobs:
  pr-lint:
    runs-on: ubuntu-latest
    if: >-
      ${% raw %}{{{% endraw %}
        (github.event_name == 'pull_request' && startsWith(github.event.pull_request.head.ref, 'story/') && github.event.pull_request.base.ref == 'develop')
        || (github.event_name == 'push' && startsWith(github.ref_name, 'story/'))
      ${% raw %}}}{% endraw %}
    steps:
      - name: Check branch when not a PR (push)
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          set -euo pipefail
          HEAD_REF="${GITHUB_REF_NAME}"
          echo "Branch: $HEAD_REF"
          if [[ ! "$HEAD_REF" =~ ^story/[0-9]+(\.[0-9]+)*-[a-z0-9-]+$ ]]; then
            echo "::error::Branch name must match: story/<id>-<slug> (e.g., story/1.1-register-with-email-or-social)"
            exit 1
          fi
      - name: Validate PR has story reference and branch naming (story/* -> develop only)
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        env:
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
          TITLE: ${{ github.event.pull_request.title }}
          BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail

          echo "Branch: $HEAD_REF"
          echo "Title: $TITLE"
          echo "Body length: ${#BODY:-0}"

          fail=0

          # Allow multi-part numeric ids like 0.1 or 1.2.3
          if [[ ! "$HEAD_REF" =~ ^story/[0-9]+(\.[0-9]+)*-[a-z0-9-]+$ ]]; then
            echo "::error::Branch name must match: story/<id>-<slug> (e.g., story/1.1-register-with-email-or-social)"
            fail=1
          fi

          # Case-insensitive check allowing separators: space, hyphen, slash, or colon
          TEXT=$(printf '%s' "$TITLE $BODY" | tr '[:upper:]' '[:lower:]')
          if [[ ! "$TEXT" =~ story[[:space:]/:-]*[0-9]+(\.[0-9]+)* ]]; then
            echo "::error::PR title or body must include a story id reference (e.g., story 1.1, story-1.1, story/1.1, or story: 1.1)"
            fail=1
          fi

          # Keep lint simple; print reminder unconditionally.
          echo "::notice::Reminder: Ensure the story's Status is updated appropriately."
          exit $fail



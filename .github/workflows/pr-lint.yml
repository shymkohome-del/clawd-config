name: PR Lint

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  push:
    branches:
      - 'story/**'

jobs:
  pr-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch when not a PR (push)
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          set -euo pipefail
          HEAD_REF="${GITHUB_REF_NAME}"
          echo "Branch: $HEAD_REF"
          if [[ ! "$HEAD_REF" =~ ^story/[0-9]+(\.[0-9]+)*-[a-z0-9-]+$ ]]; then
            echo "::error::Branch name must match: story/<id>-<slug> (e.g., story/1.1-register-with-email-or-social)"
            exit 1
          fi
      - name: Validate PR has story reference and branch naming
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref != 'develop' }}
        shell: bash
        run: |
          set -euo pipefail
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"

          echo "Branch: $HEAD_REF"
          echo "Title: $TITLE"
          echo "Body length: ${#BODY}"

          fail=0

          # Allow multi-part numeric ids like 0.1 or 1.2.3
          if [[ ! "$HEAD_REF" =~ ^story/[0-9]+(\.[0-9]+)*-[a-z0-9-]+$ ]]; then
            echo "::error::Branch name must match: story/<id>-<slug> (e.g., story/1.1-register-with-email-or-social)"
            fail=1
          fi

          # Case-insensitive check allowing separators: space, hyphen, slash, or colon
          TEXT=$(echo "$TITLE $BODY" | tr '[:upper:]' '[:lower:]')
          if [[ ! "$TEXT" =~ story[[:space:]/:-]*[0-9]+(\.[0-9]+)* ]]; then
            echo "::error::PR title or body must include a story id reference (e.g., story 1.1, story-1.1, story/1.1, or story: 1.1)"
            fail=1
          fi

          # Optional status nudge: if a single story file is touched, warn if status isn't set to an expected state
          CHANGED_STORIES=$(jq -r '.pull_request | .number' <(echo "${{ toJson(github.event) }}") >/dev/null 2>&1; echo "")
          # GitHub doesn't expose changed files in this context directly without additional API calls.
          # Keep lint simple; print reminder unconditionally.
          echo "::notice::Reminder: Ensure the story's Status is updated: Dev → InProgress/Ready for Review; QA → Done after acceptance."
          exit $fail



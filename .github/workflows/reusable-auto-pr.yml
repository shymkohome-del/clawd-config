name: Reusable - Auto PR and Auto-merge

on:
  workflow_call:
    inputs:
      branch:
        description: Branch name to operate on (defaults to github.ref_name)
        required: false
        type: string
      enable_auto_merge:
        description: Whether to attempt enabling auto-merge via GraphQL
        required: false
        type: boolean
        default: true
      auto_approve:
        description: Whether to auto-approve PR (bot review)
        required: false
        type: boolean
        default: false
      dry_run:
        description: If true, simulate without network calls
        required: false
        type: boolean
        default: false
    outputs:
      pr_number:
        description: Created or reused PR number
        value: ${{ jobs.run.outputs.pr_number }}

permissions:
  contents: write
  pull-requests: write

jobs:
  run:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.create_pr.outputs.pr_number }}
      pr_created: ${{ steps.create_pr.outputs.pr_created }}
      pr_reused: ${{ steps.create_pr.outputs.pr_reused }}
      pr_reason: ${{ steps.create_pr.outputs.reason }}
      auto_merge_attempted: ${{ steps.enable_am.outputs.attempted }}
      auto_merge_enabled: ${{ steps.enable_am.outputs.enabled }}
      auto_merge_reason: ${{ steps.enable_am.outputs.reason }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Common setup
        uses: ./.github/actions/common-setup
        with:
          prepare_scripts: 'true'

      - name: Resolve branch and mode
        id: ctx
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${{ inputs.branch || github.ref_name }}"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "dry_run=${{ inputs.dry_run }}" >> "$GITHUB_OUTPUT"

      - name: Derive branch meta and QA Done (if story branch)
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${{ steps.ctx.outputs.branch }}"
          echo "branch_name=$BRANCH" >> "$GITHUB_OUTPUT"
          if [[ "$BRANCH" =~ ^story/([0-9]+(\.[0-9]+)*)- ]]; then
            STORY_ID="${BASH_REMATCH[1]}"
            STORY_FILE=$(ls docs/stories/${STORY_ID}.*.md 2>/dev/null | head -n1 || true)
            if [[ -z "${STORY_FILE:-}" ]]; then
              echo "qa_done=false" >> "$GITHUB_OUTPUT"
              echo "reason=story-file-missing" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            STATUS_LINE=$(grep -iE '^Status:' "$STORY_FILE" || true)
            if echo "$STATUS_LINE" | grep -qi 'Done'; then
              echo "qa_done=true" >> "$GITHUB_OUTPUT"
              echo "story_id=$STORY_ID" >> "$GITHUB_OUTPUT"
              echo "story_file=$STORY_FILE" >> "$GITHUB_OUTPUT"
            else
              echo "qa_done=false" >> "$GITHUB_OUTPUT"
              echo "reason=status-not-done" >> "$GITHUB_OUTPUT"
            fi
          elif [[ "$BRANCH" =~ ^(feature|fix|chore|patch)/ ]]; then
            echo "qa_done=true" >> "$GITHUB_OUTPUT"
            echo "story_id=" >> "$GITHUB_OUTPUT"
            echo "story_file=" >> "$GITHUB_OUTPUT"
          else
            echo "qa_done=false" >> "$GITHUB_OUTPUT"
            echo "reason=unsupported-branch" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure PR exists (REST API)
        id: create_pr
        if: steps.meta.outputs.qa_done == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Ensure PR exists"
          if [[ "${{ steps.ctx.outputs.dry_run }}" == "true" || "${CI_LOCAL:-}" == "true" ]]; then
            echo "dry-run: Skipping PR query/create."
            echo "::endgroup::"
            exit 0
          fi
          BRANCH="${{ steps.ctx.outputs.branch }}"
          STORY_ID="${{ steps.meta.outputs.story_id }}"
          STORY_FILE="${{ steps.meta.outputs.story_file }}"
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          API="https://api.github.com"

          RESP=$(
            ./scripts/retry.sh 5 2 -- bash -lc \
              "curl -sS -i -H 'authorization: Bearer ${GH_TOKEN}' -H 'accept: application/vnd.github+json' \
                -w '\nHTTPSTATUS:%{http_code}' \"${API}/repos/${OWNER}/${REPO}/pulls?head=${OWNER}:${BRANCH}&state=open\""
          )
          HTTP_CODE=$(echo "$RESP" | sed -n '$s/.*HTTPSTATUS:\([0-9][0-9][0-9]\).*/\1/p')
          RESP_BODY=$(echo "$RESP" | sed '$d' | awk 'BEGIN{p=0} p{print} /^\r?$/{p=1}')
          EXISTING=$(printf '%s' "$RESP_BODY" | jq '.[0].number // empty')
          if [[ -n "${EXISTING}" ]]; then
            echo "PR already exists: #${EXISTING}"
            echo "pr_number=${EXISTING}" >> "$GITHUB_OUTPUT"
            echo "pr_created=false" >> "$GITHUB_OUTPUT"
            echo "pr_reused=true" >> "$GITHUB_OUTPUT"
            echo "reason=pr-exists" >> "$GITHUB_OUTPUT"
          else
            if [[ -n "$STORY_ID" ]]; then
              TITLE="Story ${STORY_ID}: QA Done â€” auto PR to develop"
              BODY=$'This PR was auto-created after QA marked Status: Done in the story file.\n\nMerge strategy: squash; delete source branch on merge.'
              BODY="${BODY}\n\nstory ${STORY_ID}\n\nchanged: \`${STORY_FILE}\`"
            else
              TITLE="Auto PR to develop for $BRANCH"
              BODY=$'This PR was auto-created after changes were pushed to this branch.\n\nMerge strategy: squash; delete source branch on merge.'
            fi

            PAYLOAD=$(jq -cn --arg title "$TITLE" --arg head "$BRANCH" --arg base "develop" --arg body "$BODY" '{title:$title, head:$head, base:$base, body:$body}')
            RESP=$(
              ./scripts/retry.sh 5 2 -- bash -lc \
                "curl -sS -i -H 'authorization: Bearer ${GH_TOKEN}' -H 'accept: application/vnd.github+json' -d '$PAYLOAD' \
                  -w '\nHTTPSTATUS:%{http_code}' \"${API}/repos/${OWNER}/${REPO}/pulls\""
            )
            HTTP_CODE=$(echo "$RESP" | sed -n '$s/.*HTTPSTATUS:\([0-9][0-9][0-9]\).*/\1/p')
            RESP_BODY=$(echo "$RESP" | sed '$d' | awk 'BEGIN{p=0} p{print} /^\r?$/{p=1}')
            if [[ "$HTTP_CODE" == "403" ]]; then
              MSG=$(printf '%s' "$RESP_BODY" | jq -r '.message // empty')
              echo "Permission denied (HTTP 403) creating PR: ${MSG}. Skipping create; downstream steps will no-op."
              echo "reason=insufficient-permissions" >> "$GITHUB_OUTPUT"
              echo "::endgroup::"
              exit 0
            fi
            PR_NUMBER=$(printf '%s' "$RESP_BODY" | jq '.number')
            if [[ -z "${PR_NUMBER}" || "${PR_NUMBER}" == "null" ]]; then
              echo "Failed to create PR (HTTP ${HTTP_CODE})" >&2
              printf '%s\n' "$RESP_BODY" >&2
              echo "::endgroup::"
              exit 1
            fi
            echo "Created PR: #${PR_NUMBER}"
            echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
            echo "pr_created=true" >> "$GITHUB_OUTPUT"
            echo "pr_reused=false" >> "$GITHUB_OUTPUT"
            echo "reason=pr-created" >> "$GITHUB_OUTPUT"
          fi
          echo "::endgroup::"

      - name: Label PR (automerge-candidate)
        if: steps.meta.outputs.qa_done == 'true' && steps.meta.outputs.story_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Label PR (automerge-candidate)"
          if [[ "${{ steps.ctx.outputs.dry_run }}" == "true" || "${CI_LOCAL:-}" == "true" ]]; then
            echo "dry-run: Skipping label application (automerge-candidate)."
            echo "::endgroup::"
            exit 0
          fi
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          API="https://api.github.com"
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number || '' }}"
          if [[ -z "$PR_NUMBER" ]]; then
            BRANCH="${{ steps.ctx.outputs.branch }}"
            RESP=$(
              ./scripts/retry.sh 5 2 -- bash -lc \
                "curl -sS -i -H 'authorization: Bearer ${GH_TOKEN}' -H 'accept: application/vnd.github+json' \
                  -w '\nHTTPSTATUS:%{http_code}' \"${API}/repos/${OWNER}/${REPO}/pulls?head=${OWNER}:${BRANCH}&state=open\""
            )
            RESP_BODY=$(echo "$RESP" | sed '$d' | awk 'BEGIN{p=0} p{print} /^\r?$/{p=1}')
            PR_NUMBER=$(printf '%s' "$RESP_BODY" | jq '.[0].number // empty')
          fi
          if [[ -z "$PR_NUMBER" ]]; then
            echo "No PR found to label. Skipping."
            echo "::endgroup::"
            exit 0
          fi
          PAYLOAD='{"labels":["automerge-candidate"]}'
          ./scripts/retry.sh 5 2 -- bash -lc \
            "curl -sS -i -X POST -H 'authorization: Bearer ${GH_TOKEN}' -H 'accept: application/vnd.github+json' -H 'content-type: application/json' \
              -w '\nHTTPSTATUS:%{http_code}' -d '$PAYLOAD' \"${API}/repos/${OWNER}/${REPO}/issues/${PR_NUMBER}/labels\"" >/dev/null || true
          echo "::endgroup::"

      - name: Label PR (automerge-ok)
        if: steps.meta.outputs.qa_done == 'true' && steps.meta.outputs.story_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Label PR (automerge-ok)"
          if [[ "${{ steps.ctx.outputs.dry_run }}" == "true" || "${CI_LOCAL:-}" == "true" ]]; then
            echo "dry-run: Skipping label application (automerge-ok)."
            echo "::endgroup::"
            exit 0
          fi
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          API="https://api.github.com"
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number || '' }}"
          if [[ -z "$PR_NUMBER" ]]; then
            BRANCH="${{ steps.ctx.outputs.branch }}"
            RESP=$(
              ./scripts/retry.sh 5 2 -- bash -lc \
                "curl -sS -i -H 'authorization: Bearer ${GH_TOKEN}' -H 'accept: application/vnd.github+json' \
                  -w '\nHTTPSTATUS:%{http_code}' \"${API}/repos/${OWNER}/${REPO}/pulls?head=${OWNER}:${BRANCH}&state=open\""
            )
            RESP_BODY=$(echo "$RESP" | sed '$d' | awk 'BEGIN{p=0} p{print} /^\r?$/{p=1}')
            PR_NUMBER=$(printf '%s' "$RESP_BODY" | jq '.[0].number // empty')
          fi
          if [[ -z "$PR_NUMBER" ]]; then
            echo "No PR found to label. Skipping."
            echo "::endgroup::"
            exit 0
          fi
          PAYLOAD='{"labels":["automerge-ok","qa:approved"]}'
          ./scripts/retry.sh 5 2 -- bash -lc \
            "curl -sS -i -X POST -H 'authorization: Bearer ${GH_TOKEN}' -H 'accept: application/vnd.github+json' -H 'content-type: application/json' \
              -w '\nHTTPSTATUS:%{http_code}' -d '$PAYLOAD' \"${API}/repos/${OWNER}/${REPO}/issues/${PR_NUMBER}/labels\"" >/dev/null || true
          echo "::endgroup::"

      - name: Enable auto-merge (squash)
        id: enable_am
        if: steps.meta.outputs.qa_done == 'true' && steps.meta.outputs.story_id != '' && inputs.enable_auto_merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Enable auto-merge (squash)"
          echo "attempted=true" >> "$GITHUB_OUTPUT"
          echo "enabled=false" >> "$GITHUB_OUTPUT"
          echo "reason=unknown" >> "$GITHUB_OUTPUT"
          if [[ "${{ steps.ctx.outputs.dry_run }}" == "true" || "${CI_LOCAL:-}" == "true" ]]; then
            echo "reason=dry-run" >> "$GITHUB_OUTPUT"
            echo "dry-run: Skipping GraphQL auto-merge enable."
            echo "::endgroup::"
            exit 0
          fi
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          API="https://api.github.com"
          # Check repo setting allow_auto_merge
          RESP=$(
            ./scripts/retry.sh 5 2 -- bash -lc \
              "curl -sS -i -H 'authorization: Bearer ${GH_TOKEN}' -H 'accept: application/vnd.github+json' \
                -w '\nHTTPSTATUS:%{http_code}' \"${API}/repos/${OWNER}/${REPO}\""
          )
          REPO_JSON=$(echo "$RESP" | sed '$d' | awk 'BEGIN{p=0} p{print} /^\r?$/{p=1}')
          ALLOW=$(echo "$REPO_JSON" | jq -r '.allow_auto_merge // false')
          echo "Repo allow_auto_merge=$ALLOW"
          if [[ "$ALLOW" != "true" ]]; then
            echo "reason=repo-allow-auto-merge-disabled" >> "$GITHUB_OUTPUT"
            echo "Auto-merge not enabled at repo level. Exiting gracefully."
            echo "::endgroup::"
            exit 0
          fi
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number || '' }}"
          if [[ -z "$PR_NUMBER" ]]; then
            BRANCH="${{ steps.ctx.outputs.branch }}"
            RESP=$(
              ./scripts/retry.sh 5 2 -- bash -lc \
                "curl -sS -i -H 'authorization: Bearer ${GH_TOKEN}' -H 'accept: application/vnd.github+json' \
                  -w '\nHTTPSTATUS:%{http_code}' \"${API}/repos/${OWNER}/${REPO}/pulls?head=${OWNER}:${BRANCH}&state=open\""
            )
            RESP_BODY=$(echo "$RESP" | sed '$d' | awk 'BEGIN{p=0} p{print} /^\r?$/{p=1}')
            PR_NUMBER=$(printf '%s' "$RESP_BODY" | jq '.[0].number // empty')
          fi
          if [[ -z "$PR_NUMBER" ]]; then
            echo "reason=no-open-pr" >> "$GITHUB_OUTPUT"
            echo "No PR found to enable auto-merge on. Exiting gracefully."
            echo "::endgroup::"
            exit 0
          fi
          RESP=$(
            ./scripts/retry.sh 5 2 -- bash -lc \
              "curl -sS -i -H 'authorization: Bearer ${GH_TOKEN}' -H 'accept: application/vnd.github+json' \
                -w '\nHTTPSTATUS:%{http_code}' \"${API}/repos/${OWNER}/${REPO}/pulls/${PR_NUMBER}\""
          )
          PR_JSON=$(echo "$RESP" | sed '$d' | awk 'BEGIN{p=0} p{print} /^\r?$/{p=1}')
          HEAD_BRANCH=$(echo "$PR_JSON" | jq -r '.head.ref')
          LABELS_CSV=$(echo "$PR_JSON" | jq -r '(.labels // []) | map(.name) | join(",")')
          if [[ "$HEAD_BRANCH" =~ ^story/ ]]; then
            if [[ ",${LABELS_CSV}," != *",automerge-ok,"* && ",${LABELS_CSV}," != *",qa:approved,"* ]]; then
              echo "attempted=false" >> "$GITHUB_OUTPUT"
              echo "reason=label-gate-missing" >> "$GITHUB_OUTPUT"
              echo "Note: Skipping auto-merge enable for story branch due to missing 'automerge-ok' label."
              echo "::endgroup::"
              exit 0
            fi
          fi
          NODE_ID=$(echo "$PR_JSON" | jq -r '.node_id')
          if [[ -z "$NODE_ID" || "$NODE_ID" == "null" ]]; then
            echo "reason=no-node-id" >> "$GITHUB_OUTPUT"
            echo "Failed to get PR node_id"
            echo "::endgroup::"
            exit 0
          fi
          GQL=$'mutation EnableAutoMerge($pr: ID!) {\n  enablePullRequestAutoMerge(input: { pullRequestId: $pr, mergeMethod: SQUASH }) {\n    clientMutationId\n  }\n}'
          VARIABLES=$(jq -cn --arg pr "$NODE_ID" '{pr:$pr}')
          RESP=$(
            ./scripts/retry.sh 5 2 -- bash -lc \
              "curl -sS -i -H 'authorization: Bearer ${GH_TOKEN}' -H 'content-type: application/json' \
                -w '\nHTTPSTATUS:%{http_code}' -d \"$(jq -cn --arg query \"$GQL\" --argjson variables \"$VARIABLES\" '{query:$query, variables:$variables}')\" \
                https://api.github.com/graphql"
          )
          BODY=$(echo "$RESP" | sed '$d' | awk 'BEGIN{p=0} p{print} /^\r?$/{p=1}')
          echo "$BODY" | jq '.' || true
          if echo "$BODY" | grep -q 'errors'; then
            echo "reason=graphql-error" >> "$GITHUB_OUTPUT"
            echo "Auto-merge enable failed. Leaving PR open."
            echo "::endgroup::"
            exit 0
          fi
          echo "enabled=true" >> "$GITHUB_OUTPUT"
          echo "reason=enabled" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

      - name: Emit auto-merge summary
        if: always()
        run: |
          set -euo pipefail
          echo "::group::Summary"
          echo "### Auto-merge enable summary" >> $GITHUB_STEP_SUMMARY
          echo "- Label gate accepted: $([[ \"${{ steps.enable_am.outputs.reason }}\" != \"label-gate-missing\" ]] && echo true || echo false)" >> $GITHUB_STEP_SUMMARY
          echo "- PR: #${{ steps.create_pr.outputs.pr_number || 'n/a' }}" >> $GITHUB_STEP_SUMMARY
          echo "- PR created: ${{ steps.create_pr.outputs.pr_created || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- PR reused: ${{ steps.create_pr.outputs.pr_reused || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- PR reason: ${{ steps.create_pr.outputs.reason || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ steps.ctx.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- Story ID: ${{ steps.meta.outputs.story_id || 'n/a' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Attempted: ${{ steps.enable_am.outputs.attempted }}" >> $GITHUB_STEP_SUMMARY
          echo "- Enabled: ${{ steps.enable_am.outputs.enabled }}" >> $GITHUB_STEP_SUMMARY
          echo "- Reason: ${{ steps.enable_am.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "::endgroup::"

      - name: Auto-approve PR (bot review)
        if: steps.meta.outputs.qa_done == 'true' && steps.meta.outputs.story_id != '' && inputs.auto_approve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Auto-approve PR"
          if [[ "${{ steps.ctx.outputs.dry_run }}" == "true" || "${CI_LOCAL:-}" == "true" ]]; then
            echo "dry-run: Skipping auto-approval."
            echo "::endgroup::"
            exit 0
          fi
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          API="https://api.github.com"
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number || '' }}"
          if [[ -z "$PR_NUMBER" ]]; then
            BRANCH="${{ steps.ctx.outputs.branch }}"
            RESP=$(
              ./scripts/retry.sh 5 2 -- bash -lc \
                "curl -sS -i -H 'authorization: Bearer ${GH_TOKEN}' -H 'accept: application/vnd.github+json' \
                  -w '\nHTTPSTATUS:%{http_code}' \"${API}/repos/${OWNER}/${REPO}/pulls?head=${OWNER}:${BRANCH}&state=open\""
            )
            RESP_BODY=$(echo "$RESP" | sed '$d' | awk 'BEGIN{p=0} p{print} /^\r?$/{p=1}')
            PR_NUMBER=$(printf '%s' "$RESP_BODY" | jq '.[0].number // empty')
          fi
          if [[ -z "$PR_NUMBER" ]]; then
            echo "No PR found to approve. Skipping."
            echo "::endgroup::"
            exit 0
          fi
          PAYLOAD='{"event":"APPROVE","body":"Auto-approval by reusable workflow."}'
          ./scripts/retry.sh 5 2 -- bash -lc \
            "curl -sS -i -X POST -H 'authorization: Bearer ${GH_TOKEN}' -H 'accept: application/vnd.github+json' -H 'content-type: application/json' \
              -w '\nHTTPSTATUS:%{http_code}' -d '$PAYLOAD' \"${API}/repos/${OWNER}/${REPO}/pulls/${PR_NUMBER}/reviews\"" >/dev/null || true
          echo "::endgroup::"

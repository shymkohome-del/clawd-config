name: Auto Rebase Story PRs

on:
  push:
    branches: [ develop ]
  schedule:
    - cron: '*/30 * * * *'

jobs:
  rebase:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: List open PRs from story/* to develop
        id: list
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const prs = await github.paginate(github.rest.pulls.list, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'develop'
            });
            const story = prs.filter(pr => pr.head.ref.startsWith('story/'));
            return JSON.stringify(story.map(p => ({number: p.number, ref: p.head.ref})));
      - name: Rebase each PR branch on develop (bash)
        env:
          PRS_JSON: ${{ steps.list.outputs.result }}
        shell: bash
        run: |
          set -euo pipefail
          RAW="${PRS_JSON:-}"
          if [[ -z "${RAW}" || "${RAW//[\n\t ]/}" == "" ]]; then
            echo "No story PRs to rebase."
            exit 0
          fi
          echo "Will process: ${RAW}" | sed 's/.*/[debug] &/'
          echo "$RAW" | jq -r '.[] | @base64' | while read -r row; do
            _jq() { echo "${row}" | base64 --decode | jq -r "$1"; }
            REF=$(_jq '.ref')
            echo "::group::Rebase ${REF}"
            git fetch origin develop "${REF}"
            git checkout "${REF}"
            if git rebase origin/develop; then
              git push --force-with-lease origin "${REF}"
              echo "Rebased ${REF}"
            else
              echo "::warning::Conflict rebasing ${REF}, please resolve manually."
              git rebase --abort || true
            fi
            echo "::endgroup::"
          done

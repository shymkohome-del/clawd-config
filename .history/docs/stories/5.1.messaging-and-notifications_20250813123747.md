# Story 5.1: In-app messaging and notifications

## Status
Draft

## Dependencies

- 0.5 ICP service layer bootstrap
- 0.7 Auth skeleton (UI-only)
- 0.6 Logging & error handling baseline
- 0.8 Security baseline
- 1.1 Register with email/social
- 3.1 Initiate swap (HTLC)

## Story

As a user, I want to chat with my counterparty and receive trade notifications so I can coordinate the transaction.

## Acceptance Criteria

1. Given an active trade, when I send a message, then it is persisted and visible in the conversation thread. [Source: prd/4-functional-requirements.md#45-communication-system] [Source: architecture/components.md#messaging-canister]
2. Given relevant trade events, when they occur, then I receive in-app notifications. [Source: prd/4-functional-requirements.md#45-communication-system]

### BDD Scenarios

- Scenario: Send message
  - Given an active swap conversation
  - When I send a message
  - Then both parties can view it in chronological order

- Scenario: Receive notification
  - Given I have the app open
  - When the counterparty sends a message
  - Then I see a real-time in-app notification indicator

## Tasks / Subtasks

- [ ] Frontend: Chat UI and provider (AC: 1)
  - [ ] `ChatScreen` and message input widget with pagination and grouping. [Source: architecture/frontend-architecture.md#flutter-app-structure]

- [ ] Frontend: Notifications (AC: 2)
  - [ ] In-app indicators for unread messages/trade updates; push can be deferred. [Source: prd/4-functional-requirements.md#45-communication-system]

- [ ] Backend: Messaging canister (AC: 1)
  - [ ] Confirm/define `sendMessage`, `getMessages`, `markAsRead`. [Source: architecture/components.md#messaging-canister]

- [ ] Security (AC: 1, 2)
  - [ ] Validate principals and enforce access to only trade participants. [Source: architecture/coding-standards.md#critical-fullstack-rules]

- [ ] Testing (AC: 1, 2)
  - [ ] Widget tests for chat UI and notification badges. [Source: architecture/testing-strategy.md#test-organization]
  - [ ] Canister unit tests for message send/retrieve. [Source: architecture/testing-strategy.md#test-organization]

## Dev Notes

### Data Models

- Message fields (implied by canister design): sender, recipient, content, timestamp, read state. [Source: architecture/components.md#messaging-canister]

### APIs

- Messaging canister interfaces per components doc. [Source: architecture/components.md#messaging-canister]

### Structure and Workflows

- Screens in `lib/features/chat/`; service calls via ICP service layer. [Source: architecture/frontend-architecture.md#frontend-services-layer]

## Testing

- Verify:
  - Message send/receive flows and unread indicators
  - Access control enforces conversation participants only

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft created for Story 5.1 | Scrum Master |

## Dev Agent Record

- Agent Model Used: _TBD_
- Debug Log References: _TBD_
- Completion Notes List: _TBD_
- File List: _TBD_

## QA Results

_TBD_



# Story 1.2: Profile & reputation

## Status
Ready for Review

## Dependencies

- 0.5 ICP service layer bootstrap
- 0.7 Auth skeleton (UI-only)
- 0.6 Logging & error handling baseline
- 0.8 Security baseline
- 1.1 Register with email/social

## Story

As a user, I want to edit my profile and view my reputation, so that other users can trust my identity and history.

## Acceptance Criteria

1. Given I am authenticated, when I update profile fields (username, profile image), then the changes persist and are reflected in my profile view. [Source: prd/4-functional-requirements.md#41-user-management] [Source: architecture/api-specification.md#user-management-canister]
2. Given my account has a reputation score, when I view my profile, then my reputation is displayed. [Source: prd/4-functional-requirements.md#41-user-management] [Source: architecture/data-models.md#user-model]
3. Given I upload a profile image, when the upload completes, then the image is stored via IPFS hash and shown on my profile. [Source: architecture/frontend-architecture.md#flutter-app-structure]

### BDD Scenarios

- Scenario: Update profile
  - Given I am logged in
  - When I change my username and upload a profile image
  - Then my profile is updated and I can see the new details

- Scenario: View reputation
  - Given I am logged in
  - When I open the profile screen
  - Then I see my current reputation score

- Scenario: Validation error
  - Given I am on the profile form
  - When I enter an invalid username
  - Then I see validation errors and cannot submit

## Tasks / Subtasks

- [ ] Frontend: Profile UI and provider (AC: 1, 2)
  - [ ] Add `ProfileScreen` for view/edit with form validation. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Riverpod provider for loading/saving profile and exposing reputation. [Source: architecture/frontend-architecture.md#state-management-architecture]

- [ ] Frontend: Service layer integration (AC: 1, 2)
  - [ ] Implement `UserService.getUserProfile` and `updateUserProfile`. [Source: architecture/api-specification.md#user-management-canister]
  - [ ] Map Result errors and display via shared error UI. [Source: architecture/coding-standards.md#critical-fullstack-rules]
  - [ ] Integrate image picker and IPFS upload; store returned hash in profile image. [Source: architecture/frontend-architecture.md#frontend-services-layer]

- [ ] Backend: User Management canister (AC: 1, 2)
  - [ ] Confirm/define Candid methods `getUserProfile`, `updateUserProfile`, `updateReputation`. [Source: architecture/api-specification.md#user-management-canister]
  - [ ] Validate inputs and enforce principal checks. [Source: architecture/coding-standards.md#critical-fullstack-rules]

- [ ] Security & Observability (AC: 1, 2)
  - [ ] Enforce authenticated principal updates only; log profile updates. [Source: architecture/security-and-performance.md#security-requirements]
  - [ ] Add Crashlytics breadcrumbs for profile save events. [Source: architecture/monitoring-and-observability.md#monitoring-stack]

- [ ] Testing (AC: 1, 2)
  - [ ] Widget tests for profile form validation and save flow. [Source: architecture/testing-strategy.md#test-organization]
  - [ ] Canister unit tests for profile update and reputation retrieval. [Source: architecture/testing-strategy.md#test-organization]

## Dev Notes

### Previous Story Insights

- Depends on 1.1 for authenticated users and principal mapping. [Source: prd/4b-user-stories-and-acceptance.md#e1-user-identity]

### Data Models

- User fields: `id`, `username`, `email`, `reputation`, `kycVerified`, `profileImage?`. [Source: architecture/data-models.md#user-model]

### API Specifications

- `getUserProfile(user: Principal) -> ?User`, `updateUserProfile(updates: UserUpdate) -> Result<(), Text>`, `updateReputation(user: Principal, change: Int) -> Result<(), Text>`. [Source: architecture/api-specification.md#user-management-canister]

### Component Specifications

- Frontend: `lib/features/auth/screens/profile_screen.dart`, providers under `lib/features/auth/providers/`. [Source: architecture/frontend-architecture.md#flutter-app-structure]

### File Locations

- Services in `lib/core/blockchain/icp_service.dart` and `lib/core/.../user_service.dart`. [Source: architecture/frontend-architecture.md#frontend-services-layer]

### Testing Requirements

- Tests in `test/unit/widgets/` and `test/integration/screens/` for profile. Canister tests under `canisters/user_management/test/`. [Source: architecture/testing-strategy.md#test-organization]

### Technical Constraints

- Validate inputs, never mutate state directly, and handle Result types. [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Core Workflows

- Profile view/edit integrated with service calls; reputation displayed from user model. [Source: architecture/core-workflows.md#user-registration-flow]

### Project Structure Notes

- Monorepo references translate to this appâ€™s `lib/` feature structure; canisters treated as external services via ICP service layer. [Source: architecture/unified-project-structure.md#monorepo-structure]

## Testing

- Verify:
  - Username update saves and persists after reload
  - Profile image upload stores IPFS hash and displays image
  - Reputation score is retrieved and visible

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft created for Story 1.2 | Scrum Master |

## Dev Agent Record

- Agent Model Used: _TBD_
- Debug Log References: _TBD_
- Completion Notes List: _TBD_
- File List: _TBD_

## QA Results

_TBD_



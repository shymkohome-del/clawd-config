# Story 0.5: ICP service layer bootstrap

## Status
Ready for Review

## Dependencies

- 0.3 Config & secrets
- 0.4 App structure alignment

## Story

As a developer, I want an ICP service layer with canister client stubs and error mapping, so that features can call canisters through a stable API.

## Acceptance Criteria

1. `ICPService` skeleton exists with initialization hooks for market, user_management, atomic_swap, price_oracle. [Source: docs/architecture/frontend-architecture.md#frontend-services-layer]
2. Initial methods available: `register(email, password, username)`, `loginWithOAuth(provider, token)`, `getUserProfile(principal)`. [Source: docs/architecture/api-specification.md#icp-candid-interface]
3. Result errors mapped to domain errors (e.g., `AuthError { invalidCredentials, oauthDenied, network, unknown }`). [Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
4. Service is injected into `auth` and `market` providers. [Source: docs/architecture/frontend-architecture.md#state-management-architecture]

### BDD Scenarios

- Scenario: Registration call returns a domain result
  - Given `ICPService` is initialized
  - When I call `register(email, password, username)`
  - Then I receive a typed Result and errors are mapped to `AuthError`

-- Scenario: Service injection available to features
  - Given the `auth` and `market` providers
  - When the app starts
  - Then the service is injected and available to those providers

## Tasks / Subtasks

- [ ] Create `lib/core/blockchain/icp_service.dart` skeleton with actor init. (AC: 1)
- [ ] Implement `register`, `loginWithOAuth`, `getUserProfile` stubs. (AC: 2)
- [ ] Add error mapping utilities and `AuthError` enum/class. (AC: 3)
- [ ] Wire into providers for `auth` and `market` features. (AC: 4)

## Dev Notes

- Use the interface patterns shown (actor initialization and typed mapping). [Source: docs/architecture/frontend-architecture.md#frontend-services-layer]
- Follow Candid type definitions for request/response shapes. [Source: docs/architecture/api-specification.md#icp-candid-interface]

## Testing

- Unit tests verify actor initialization and error mapping (`AuthError`) paths. [Source: docs/architecture/testing-strategy.md#test-organization]
- Widget test: auth flow uses injected service without runtime errors (mocked service provider).

## Key Files to Create/Modify

- `crypto_market/lib/core/blockchain/icp_service.dart` (actor init + stubs)
- `crypto_market/lib/core/blockchain/errors.dart` (e.g., `AuthError` and mapping)
- Providers: `crypto_market/lib/features/auth/providers/` and `crypto_market/lib/features/market/providers/`

## References

- `docs/architecture/frontend-architecture.md#frontend-services-layer`
- `docs/architecture/api-specification.md#icp-candid-interface`

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft for ICP service layer | Scrum Master |

## Dev Agent Record

- Agent Model Used: _TBD_
- Debug Log References: _TBD_
- Completion Notes List: _TBD_
- File List: _TBD_

## QA Results

- Pending implementation. On completion, verify:
  - `icp_service.dart` exists with init and stubs for `register`, `loginWithOAuth`, `getUserProfile`
  - `errors.dart` defines `AuthError` and mapping helpers
  - Providers in `auth` and `market` inject the service



- Findings:
  - Status: Blocked; not met
  - Evidence:
    - `lib/core/blockchain/` directory not present
    - `lib/core/blockchain/icp_service.dart`: not found
    - `lib/core/blockchain/errors.dart`: not found
    - No provider injection references under `features/auth/` or `features/market/`
    - Dependencies 0.3 and 0.4 are incomplete (config layer and routes/blockchain folder)
- Actions to pass (after 0.3 and 0.4):
  - Create `lib/core/blockchain/` and add `icp_service.dart` skeleton with actor init hooks
  - Implement stubs: `register`, `loginWithOAuth`, `getUserProfile`; map errors to `AuthError`
  - Add `errors.dart` with `AuthError` and mapping utilities
  - Inject service into `auth` and `market` providers
  - Tests: unit tests for actor init and error mapping; widget test for auth flow with mocked service
- Re-test checklist:
  - Service methods return typed Results with proper error mapping
  - Providers resolve injected service without runtime errors
  - CI tests pass

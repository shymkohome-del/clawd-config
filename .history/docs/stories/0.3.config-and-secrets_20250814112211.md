# Story 0.3: Config & secrets

## Status
Ready for Review

## Dependencies

- 0.1 Repo & CI baseline

## Story

As a developer, I want a clear config/secrets structure (.env.example and loaders), so that OAuth, IPFS, and canister IDs can be configured safely without code changes.

## Acceptance Criteria

1. `.env.example` lists required variables:
   - OAuth: `OAUTH_GOOGLE_CLIENT_ID`, `OAUTH_GOOGLE_CLIENT_SECRET`, `OAUTH_APPLE_TEAM_ID`, `OAUTH_APPLE_KEY_ID`
   - IPFS: `IPFS_NODE_URL`, `IPFS_GATEWAY_URL`
   - Canisters: `CANISTER_ID_MARKETPLACE`, `CANISTER_ID_USER_MANAGEMENT`, `CANISTER_ID_ATOMIC_SWAP`, `CANISTER_ID_PRICE_ORACLE`
   - Price APIs: `CHAINLINK_API_KEY` (optional), `COINGECKO_API_KEY` (optional)
   - KYC: `KYC_PROVIDER_API_KEY` (if applicable)
   [Source: architecture/external-apis.md#ipfs-api] [Source: architecture/external-apis.md#kyc-provider-apis]
2. App loads config via a single config layer at `lib/core/config/app_config.dart` using `--dart-define` or `.env` loader; secrets are not committed. [Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
3. Config keys and usage are documented in `README.md`, including local/dev/prod conventions and rotation strategy. [Source: architecture/tech-stack.md#technology-stack-table]

## Key Files to Create/Modify

- `.env.example` (repo root)
- `crypto_market/lib/core/config/app_config.dart`
- `README.md` (add config/rotation/run commands section)

### Inline Summary: AppConfig error behavior

- If a required key is missing at startup, the config layer must surface a user-visible error state: "Missing required config: <KEY>" and prevent app crash. A debug log entry is written. In tests, constructing `AppConfig` without a required key throws/returns a typed error which the UI translates to the error state.

## References

- `docs/architecture/external-apis.md#ipfs-api`
- `docs/architecture/external-apis.md#kyc-provider-apis`
- `docs/architecture/coding-standards.md#critical-fullstack-rules`
- `docs/architecture/frontend-architecture.md#frontend-services-layer`

### BDD Scenarios

- Scenario: App loads with required config
  - Given all required keys are present in the runtime configuration
  - When the app initializes via the config layer
  - Then initialization succeeds and the app does not crash

- Scenario: App surfaces clear error when a required key is missing
  - Given one or more required keys are missing
  - When the app initializes
  - Then a clear error state is shown: "Missing required config: <KEY>" and the app does not crash

## Tasks / Subtasks

- [ ] Create/update `.env.example` with exact keys above. (AC: 1) [Source: architecture/external-apis.md]
- [ ] Implement `lib/core/config/app_config.dart` and reference from ICP service. (AC: 2) [Source: architecture/frontend-architecture.md#frontend-services-layer]
- [ ] Document config variables and rotation strategy in `README.md` (include `--dart-define`). (AC: 3)

## Dev Notes

- Tech selection implies multiple external APIs (KYC, Chainlink, CoinGecko, IPFS); list their keys/URLs explicitly. [Source: architecture/external-apis.md]
- Avoid direct environment access; use config objects. [Source: architecture/coding-standards.md#critical-fullstack-rules]

## Testing

- Smoke test: with required keys present app initializes; if missing, app surfaces a clear error state: "Missing required config: <KEY>" and does not crash. [Source: architecture/coding-standards.md#critical-fullstack-rules]
- Unit test: `app_config_test.dart` validates required keys enforcement and default handling.
- Manual check: build with `--dart-define` overrides for 1â€“2 keys and verify precedence over `.env`.

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft for config/secrets | Scrum Master |

## Dev Agent Record

- Agent Model Used: _TBD_
- Debug Log References: _TBD_
- Completion Notes List: _TBD_
- File List: _TBD_

## QA Results

- Pending implementation. On completion, verify:
  - `.env.example` exists with all listed keys
  - `crypto_market/lib/core/config/app_config.dart` present and used by app initialization
  - `README.md` includes setup and rotation guidance


- Findings:
  - Status: Not met
  - Evidence:
    - `.env.example`: not found at repo root
    - `crypto_market/lib/core/config/app_config.dart`: not found
    - `README.md`: no config/rotation or `--dart-define` documentation
  - Gaps vs Acceptance Criteria: AC1, AC2, AC3 not met
  - Risks: misconfiguration at runtime; potential secrets mishandling without clear rotation/run guidance
- Actions to pass:
  - Add `.env.example` with keys enumerated in AC1 (OAuth, IPFS, Canisters, Price APIs, KYC)
  - Implement `lib/core/config/app_config.dart` with required-key enforcement and `--dart-define` precedence
  - Add unit tests `test/unit/app_config_test.dart` covering missing-key error and defaults
  - Update root `README.md` with setup, rotation guidance, and run commands using `--dart-define`
- Re-test checklist:
  - App initializes with all keys present
  - Removing a required key surfaces: "Missing required config: <KEY>" without crash
  - `--dart-define` overrides take precedence over `.env`
  - Unit tests pass in CI



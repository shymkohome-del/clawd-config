# Story 4.1: Payment method capture & confirmation

## Status
Draft

## Dependencies

- 0.5 ICP service layer bootstrap
- 0.7 Auth skeleton (UI-only)
- 0.6 Logging & error handling baseline
- 0.8 Security baseline
- 1.1 Register with email/social
- 2.1 Create listing
- 3.1 Initiate swap (HTLC)

## Story

As a seller, I want to capture my preferred payment method and confirm when I receive payment, so that the buyer can complete the swap.

## Acceptance Criteria

1. Given I am authenticated, when I add or edit payment methods (e.g., bank transfer, wallet), then they are saved and available during trades. [Source: prd/4-functional-requirements.md#44-payment-methods]
2. Given a swap is in progress, when I confirm payment received, then the system records the confirmation and allows completion. [Source: prd/4-functional-requirements.md#42-trading-functions]

### BDD Scenarios

- Scenario: Add payment method
  - Given I am logged in
  - When I add a bank transfer method
  - Then it saves and is selectable for new listings/trades

- Scenario: Confirm payment
  - Given there is an active swap
  - When I tap “Payment received”
  - Then the trade state reflects confirmation and buyer can proceed

## Tasks / Subtasks

- [ ] Frontend: Payment methods UI and provider (AC: 1)
  - [ ] Add manage payment methods screen and form validation. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Persist choices locally and via service layer backing (if modeled on back end). [Source: architecture/frontend-architecture.md#frontend-services-layer]

- [ ] Frontend: Trade confirmation UI (AC: 2)
  - [ ] Add “Payment received” control on `SwapDetailScreen`. [Source: architecture/frontend-architecture.md#flutter-app-structure]

- [ ] Backend/Service integration (AC: 1, 2)
  - [ ] Model payment methods either in user profile or listing terms; wire via service layer. [Source: prd/4-functional-requirements.md#44-payment-methods]
  - [ ] Ensure trade confirmation updates swap status gating completion. [Source: architecture/core-workflows.md#atomic-swap-flow]

- [ ] Security & Error Handling (AC: 1, 2)
  - [ ] Validate principal, sanitize inputs, and handle errors with Result mapping. [Source: architecture/coding-standards.md#critical-fullstack-rules] [Source: architecture/error-handling-strategy.md#error-flow]

- [ ] Testing (AC: 1, 2)
  - [ ] Widget tests for payment method forms and trade confirmation. [Source: architecture/testing-strategy.md#test-organization]

## Dev Notes

### Data Models

- Payment method fields per FRs; storage may be in user profile or listing metadata. [Source: prd/4-functional-requirements.md#44-payment-methods]

### APIs

- If persisted on-chain, add/update user profile or listing interfaces accordingly. [Source: architecture/api-specification.md]

### Structure and Workflows

- Screens in `lib/features/trading/` and `lib/features/profile/` as applicable; service calls via ICP service layer. [Source: architecture/frontend-architecture.md#frontend-services-layer]
- Confirmation step aligns with Atomic Swap flow. [Source: architecture/core-workflows.md#atomic-swap-flow]

## Testing

- Verify:
  - Payment methods add/edit/delete flows
  - Confirmation toggles the swap to allow completion

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft created for Story 4.1 | Scrum Master |

## Dev Agent Record

- Agent Model Used: _TBD_
- Debug Log References: _TBD_
- Completion Notes List: _TBD_
- File List: _TBD_

## QA Results

_TBD_



# Story 3.3: Refund swap (timelock expiry)

## Status
Ready for Review

## Dependencies

- 3.1 Initiate swap (HTLC)

## Story

As a buyer, I want to refund a swap after the timelock expires so that funds are returned if the trade does not complete.

## Acceptance Criteria

1. Given timelock has expired, when I request a refund, then the canister refunds and sets status accordingly. [Source: architecture/api-specification.md#atomic-swap-canister]
2. Given timelock has not expired, when I request a refund, then it is rejected with a clear error. [Source: architecture/components.md#atomic-swap-canister]

### BDD Scenarios

- Scenario: Successful refund after expiry
  - Given a pending swap whose timeout is in the past
  - When I tap Refund
  - Then the canister processes a refund and marks the swap refunded

- Scenario: Early refund denied
  - Given a pending swap whose timeout is in the future
  - When I tap Refund
  - Then the canister rejects the request

## Tasks / Subtasks

- [ ] Frontend: Refund UI (AC: 1, 2)
  - [ ] Show timelock countdown and enable Refund when expired. [Source: architecture/frontend-architecture.md#flutter-app-structure]

- [ ] Frontend: Service call (AC: 1)
  - [ ] Call `refundSwap(swapId)` and handle errors. [Source: architecture/api-specification.md#atomic-swap-canister]

- [ ] Backend: Canister validation (AC: 1, 2)
  - [ ] Implement refund guardrails; update status. [Source: architecture/components.md#atomic-swap-canister]

- [ ] Testing (AC: 1, 2)
  - [ ] Widget tests for countdown and refund gate; canister unit tests. [Source: architecture/testing-strategy.md#test-organization]

## Dev Notes

### Data Models & APIs

- `refundSwap(swapId) -> Result<(), Text>`. [Source: architecture/api-specification.md#atomic-swap-canister]

### Workflows

- Align with atomic swap flow error/edge paths. [Source: architecture/core-workflows.md#atomic-swap-flow]

## Testing

- Verify:
  - Expired swaps can refund successfully
  - Early refund attempts show appropriate error

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft created for Story 3.3 | Scrum Master |

## Dev Agent Record

- Agent Model Used: _TBD_
- Debug Log References: _TBD_
- Completion Notes List: _TBD_
- File List: _TBD_

## QA Results

_TBD_



Title: Story 0.9.2 — Deterministic PR creation (no gh CLI)
Status: Done

# Story 0.9.2: Deterministic PR creation without gh CLI

## Story

As a repo maintainer, I want PR creation to be idempotent and based on REST/GraphQL only, so that re‑runs never duplicate PRs and behavior is predictable across runners.

## Acceptance Criteria

1. The workflow uses only REST/GraphQL APIs; no `gh` CLI calls remain.
2. Idempotency: prior to creating a PR, the workflow queries by `head` and reuses an existing PR if present.
3. The `pr_number` is written to `$GITHUB_OUTPUT` in the create/reuse step and reused by later steps.
4. Titles/bodies are consistent and validated: `story/*` must include parsed story ID; `feature/*`/`fix/*`/`chore/*`/`patch/*` use a generic title.
5. A `automerge-candidate` label is added on the PR.
6. For `story/*`, PRs are created only when the story file contains `Status: Done`.

## Dependencies

- 0.9.1 Workflow lint and flags

## Tasks / Subtasks

- [x] Remove any remaining `gh` usage; keep `curl`+`jq` REST/GraphQL calls.
- [x] Ensure the PR creation step first queries `/pulls?head=owner:branch&state=open` and reuses if found.
- [x] Echo `pr_number=<number>` to `$GITHUB_OUTPUT` unconditionally (create or reuse path).
- [x] Validate branch and story ID parsing; fail with clear taxonomy when unsupported or missing.
- [x] Add step to apply label `automerge-candidate` using REST API.
- [x] Keep gating: only execute on `story/*` when the story file includes `Status: Done`; otherwise skip with reason.

## BDD Scenarios

- Scenario: Re‑run on same commit
  - Given a branch already has an open PR
  - When the workflow runs again
  - Then no duplicate PR is created and the existing `pr_number` is reused

- Scenario: Story gating
  - Given a `story/*` branch whose story file lacks `Status: Done`
  - When the workflow runs
  - Then PR creation is skipped with `reason=status-not-done`

## Testing

- Push multiple commits to the same branch and re‑run; verify only one PR exists.
- Change story `Status:` from `Ready for Dev` to `Done` and push; verify PR is created.

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY‑MM‑DD | 0.1 | Initial draft | Scrum Master |
| 2025-08-18 | 0.2 | QA: Re-assessment — REST-only path implemented in `auto-pr-from-qa.yml`; legacy `ci-auto-pr.yml` still uses `gh`. Marking AC1 Partial and story InProgress until legacy path is removed or aligned. | QA |
| 2025-08-18 | 0.3 | Dev: Removed legacy `ci-auto-pr.yml` (gh-based). REST/GraphQL-only path remains with idempotent PR reuse and `pr_number` output. Status set to Done. | Dev |
| 2025-08-19 | 0.4 | QA: Re-verified — legacy gh workflow removed; all ACs Pass. Status remains Done. | QA |

## Dev Agent Record

- Implemented:
  - REST-only PR creation, no `gh` CLI usage
  - Idempotent: query existing PR by `head` and reuse
  - Outputs `pr_number` for downstream steps
  - Consistent titles/bodies; `automerge-candidate` label applied
  - Gating: `story/*` PRs created only when story file contains `Status: Done`
  - Feature gating respected via `AUTO_PR_ENABLED`
- Evidence:
  - Test branch `feature/test-merge-fallback` auto-created PR #15

## QA Results

- AC1 — REST/GraphQL only: Pass. `auto-pr-from-qa.yml` uses `curl` + `jq` only; legacy `ci-auto-pr.yml` has been removed.
- AC2 — Idempotency: Pass. Queries existing PR by `head` and reuses if found.
- AC3 — Output `pr_number`: Pass. Writes `pr_number` to `$GITHUB_OUTPUT` and consumed by later steps.
- AC4 — Titles/bodies consistent: Pass. `story/*` parses story ID; non-story uses generic title.
- AC5 — Label `automerge-candidate`: Pass. Applied via REST after create/reuse.
- AC6 — Gating on `Status: Done` for `story/*`: Pass. Branch meta step checks story file status; otherwise skip with reason.

Verdict: All ACs Pass. `Status: Done`.



## Additional: Consistency & Test Plan

- Idempotency torture tests:
  - Push 3 times to the same branch; verify only 1 open PR exists and `pr_number` remains stable across re-runs.
  - Cancel and re-run workflow mid-execution; ensure reuse still occurs and no duplicate PRs are created.
- Input/output contract:
  - Confirm `pr_number` is always written to `$GITHUB_OUTPUT` on both reuse and create paths and is consumable by downstream steps.
- Branch taxonomy validation:
  - For `story/*` with `Status: Done` → PR is created; with other statuses → step is skipped with `reason=status-not-done`.
  - For unsupported branches → `reason=unsupported-branch` surfaces in logs and summaries.
- Label application:
  - Ensure `automerge-candidate` label is applied deterministically; re-run should not duplicate labels.
- Negative permissions test:
  - Temporarily reduce token permissions and confirm graceful `reason=insufficient-permissions` with no failures.

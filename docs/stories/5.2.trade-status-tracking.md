# Story 5.2: Real-time trade status tracking and notifications

## Status
Ready for Review

## Dependencies

- 2.6 Buy listing - Complete trade initiation flow
- 3.1 Initiate swap (HTLC)
- 3.2 Complete swap (secret reveal)
- 4.3 Payment method integration and validation
- 5.1 Messaging and notifications

## Story

As a buyer and seller, I want real-time visibility into trade status with automated notifications so that I know exactly what actions are needed and when to expect completion.

## Acceptance Criteria

1. Given I am participating in a trade, when the trade status changes, then I receive immediate notifications and can view current status in the app. [Source: prd/4-functional-requirements.md#45-communication-system]
2. Given I am viewing my active trades, when I open the trade details, then I see a clear progress timeline with completed, current, and pending steps. [Source: prd/0-mvp-scope.md#05-mvp-kpis]
3. Given a trade has timeouts or deadlines, when they approach, then both parties receive advance warnings with clear action items. [Source: architecture/core-workflows.md#atomic-swap-flow]
4. Given either party needs to take action, when it becomes their turn, then they receive actionable notifications with deep links to the relevant screens. [Source: prd/4-functional-requirements.md#45-communication-system]

### BDD Scenarios

- Scenario: Trade progress visualization
  - Given I have an active atomic swap
  - When I open the trade details screen
  - Then I see a timeline showing: Swap Initiated → Payment Submitted → Payment Confirmed → Swap Completed
  - And each step shows completion status, timestamps, and who is responsible for the next action

- Scenario: Real-time status updates
  - Given I am a seller with a pending trade
  - When the buyer submits payment proof
  - Then I receive an immediate push notification
  - And the trade status updates to "Payment Confirmation Required"
  - And I see a notification badge on the trades tab

- Scenario: Timeout warning notifications
  - Given I have a swap approaching its timeout deadline
  - When there are 6 hours remaining before expiry
  - Then I receive a warning notification with options to extend or complete
  - And the trade screen shows the countdown and required actions

- Scenario: Deep link navigation from notifications
  - Given I receive a trade notification on my mobile device
  - When I tap the notification
  - Then the app opens directly to the relevant trade screen
  - And shows the specific action I need to take

## Tasks / Subtasks

- [ ] Frontend: Trade Status Dashboard (AC: 1, 2)
  - [ ] Create `TradesDashboardScreen` showing all active, completed, and disputed trades. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Create `TradeDetailScreen` with comprehensive status timeline and action buttons. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Implement real-time status updates using ICP subscription patterns. [Source: architecture/backend-architecture.md#canister-based-service-architecture]
  - [ ] **Localization: Implement multi-language support for trade statuses, timeline labels, action buttons, and notification messages.**
  - [ ] **Logging: Implement debug logging for trade status changes, notification delivery, timeline updates, deep link navigation, and real-time subscription events. Ensure logging is disabled in production flavors and only active in development/staging builds.**

- [ ] Frontend: Trade Timeline Component (AC: 2)
  - [ ] Create `TradeTimelineWidget` showing progress steps with icons and timestamps. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Implement dynamic timeline that adapts to different trade types (cash, bank transfer, etc.). [Source: architecture/frontend-architecture.md#state-management-architecture]
  - [ ] Add visual indicators for overdue actions and approaching deadlines. [Source: architecture/frontend-architecture.md#flutter-app-structure]

- [ ] Frontend: Notification System Integration (AC: 1, 4)
  - [ ] Integrate with Flutter's push notification system for background updates. [Source: architecture/tech-stack.md#flutter-mobile-app]
  - [ ] Implement deep linking to navigate directly to relevant trade screens. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Add in-app notification center for notification history. [Source: architecture/frontend-architecture.md#flutter-app-structure]

- [ ] Frontend: Action-Oriented UI (AC: 4)
  - [ ] Create context-sensitive action buttons based on trade status and user role. [Source: architecture/frontend-architecture.md#state-management-architecture]
  - [ ] Implement quick actions (confirm payment, request extension, open dispute). [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Add smart notification badges showing pending action counts. [Source: architecture/frontend-architecture.md#flutter-app-structure]

- [ ] Backend: Trade Status Management (AC: 1, 2)
  - [ ] Extend Atomic Swap canister with comprehensive status tracking. [Source: architecture/api-specification.md#atomic-swap-canister]
  - [ ] Implement status change event logging with timestamps and actor information. [Source: architecture/data-models.md#atomic-swap-model]
  - [ ] Add trade history query methods for dashboard display. [Source: architecture/api-specification.md#atomic-swap-canister]

- [ ] Backend: Notification Trigger System (AC: 1, 3)
  - [ ] Create notification service that monitors trade state changes. [Source: architecture/backend-architecture.md#canister-based-service-architecture]
  - [ ] Implement timeout monitoring with configurable warning periods. [Source: architecture/core-workflows.md#atomic-swap-flow]
  - [ ] Add webhook system for external notification delivery (push notifications). [Source: architecture/backend-architecture.md#canister-based-service-architecture]

- [ ] Backend: Timeline and History Tracking (AC: 2)
  - [ ] Design comprehensive trade event model with all status transitions. [Source: architecture/data-models.md]
  - [ ] Implement efficient querying for trade history and timeline display. [Source: architecture/backend-architecture.md#canister-based-service-architecture]
  - [ ] Add proper indexing for fast trade lookup by user and status. [Source: architecture/backend-architecture.md#canister-based-service-architecture]

- [ ] Integration: Push Notification Service (AC: 4)
  - [ ] Set up Firebase Cloud Messaging for Android push notifications. [Source: architecture/tech-stack.md#flutter-mobile-app]
  - [ ] Configure Apple Push Notifications for iOS. [Source: architecture/tech-stack.md#flutter-mobile-app]
  - [ ] Implement notification templating system with proper localization. [Source: architecture/coding-standards.md#localization-requirements]

## Dev Notes

### Previous Story Insights
- Story 2.6 established the trade initiation flow that needs status tracking
- Story 4.3 added payment methods that require confirmation workflows
- Story 3.1-3.2 defined atomic swap states that need real-time monitoring
- Story 5.1 provides basic messaging infrastructure to build upon

### Data Models [Source: architecture/data-models.md]
**TradeEvent Model:**
```typescript
interface TradeEvent {
  id: string;
  swap_id: string;
  event_type: 'swap_initiated' | 'payment_submitted' | 'payment_confirmed' | 'swap_completed' | 'timeout_warning' | 'dispute_opened';
  actor: Principal;
  timestamp: bigint;
  details: string; // JSON with event-specific data
  requires_action_from?: Principal;
  action_deadline?: bigint;
}
```

**TradeStatus Model:**
```typescript
interface TradeStatus {
  swap_id: string;
  current_status: 'initiated' | 'payment_pending' | 'payment_submitted' | 'payment_confirmed' | 'completed' | 'refunded' | 'disputed' | 'expired';
  buyer: Principal;
  seller: Principal;
  next_action_required_by?: Principal;
  next_action_description?: string;
  timeout_warning_sent: boolean;
  last_updated: bigint;
}
```

### API Specifications [Source: architecture/api-specification.md]
**Atomic Swap Canister - Status Tracking:**
- `getTradeStatus(swap_id: Text) -> Result<TradeStatus, SwapError>`
- `getTradeHistory(swap_id: Text) -> Result<[TradeEvent], SwapError>`
- `getUserTrades(user: Principal, status_filter?: Text) -> Result<[TradeStatus], SwapError>`
- `subscribeToTradeUpdates(user: Principal, callback: Text) -> Result<SubscriptionId, SwapError>`

**Notification Service Canister:**
- `sendTradeNotification(recipient: Principal, notification_type: Text, trade_id: Text) -> Result<(), NotificationError>`
- `getNotificationHistory(user: Principal) -> Result<[Notification], NotificationError>`

### Component Specifications [Source: architecture/frontend-architecture.md]
**File Locations:**
- Dashboard: `lib/features/trading/screens/trades_dashboard_screen.dart`
- Trade detail: `lib/features/trading/screens/trade_detail_screen.dart`
- Timeline widget: `lib/features/trading/widgets/trade_timeline_widget.dart`
- State management: `lib/features/trading/providers/trade_status_provider.dart`
- Notification service: `lib/core/services/notification_service.dart`
- Push notifications: `lib/core/services/push_notification_service.dart`

**State Management Architecture:**
- Use Bloc/Cubit for trade status management with real-time updates
- Implement background sync for trade status when app resumes
- Cache trade status locally with sync indicators

### Testing Requirements [Source: architecture/testing-strategy.md]
**Unit Tests:**
- Trade status calculation and transition logic
- Notification trigger conditions and timing
- Timeline generation from trade events
- Deep link parsing and navigation logic

**Widget Tests:**
- Trade dashboard with various trade statuses
- Trade detail screen with timeline and actions
- Notification display and interaction
- Responsive design across device sizes

**Integration Tests:**
- End-to-end trade status tracking from initiation to completion
- Push notification delivery and deep linking
- Real-time status updates across multiple devices
- Timeout monitoring and warning system

**Performance Tests:**
- Dashboard loading with large numbers of trades
- Real-time update performance under load
- Notification delivery latency and reliability

### Technical Constraints [Source: architecture/coding-standards.md]
- Real-time updates must not exceed 2-second latency for critical status changes
- Support offline mode with sync when connectivity returns
- Handle notification permission requests gracefully
- Implement efficient polling/subscription patterns to minimize battery usage
- Support deep linking from various notification sources

### Security Considerations [Source: prd/7-security-architecture.md]
- Validate user permissions before showing trade details
- Encrypt sensitive trade information in push notification payloads
- Implement proper rate limiting for notification services
- Audit log all trade status changes for compliance
- Ensure notification deep links include proper authentication tokens

## Testing

### Unit Testing
- Test trade status calculation and validation logic
- Test notification trigger conditions and message formatting
- Test timeline generation from various trade event sequences
- Test deep link URL generation and parsing

### Widget Testing
- Test trade dashboard UI with different trade states
- Test trade detail screen with various status combinations
- Test notification display and user interaction flows
- Test responsive layout across different screen sizes

### Integration Testing
- Test complete trade lifecycle with status tracking
- Test push notification delivery and deep linking functionality
- Test real-time status synchronization across multiple devices
- Test timeout monitoring and warning notification system

### Performance Testing
- Measure dashboard loading performance with large trade volumes
- Test notification delivery latency and reliability
- Validate memory usage during real-time status updates
- Test battery usage optimization for background monitoring

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | 1.0 | Initial story creation for trade status tracking | SM |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent during review*
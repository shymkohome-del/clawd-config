Title: Story 0.13 — Codex Cloud multi-language tooling (Flutter + Motoko)
Status: InProgress

# Story 0.13: Ensure Codex Cloud environments fully support repo tooling across languages

## Story

As a dev/agent operator, I want a Codex Cloud Environment that reliably supports all repo tooling (Flutter/Dart, Motoko/DFX, Node.js, optional Rust) so agents can run format/analyze/tests and basic canister workflows entirely in the cloud without manual setup.

## Acceptance Criteria

1. Flutter/Dart parity
   - `flutter --version` prints 3.35.1 and `dart --version` is available.
   - In `crypto_market`, these pass without network after setup cache:
     - `dart format --output=none --set-exit-if-changed .`
     - `flutter analyze --fatal-infos --fatal-warnings`
     - `flutter test --no-pub`

2. Motoko/DFX availability (guarded)
   - When the environment variable `CODEX_SETUP_MOTOKO=true` is set in the environment config, setup installs DFX and Motoko:
     - `dfx --version` prints a version ≥ 0.15.x
     - `moc --version` prints a version
   - Setup is idempotent and skips re-install if present.

3. Node.js parity (for tooling/tests)
   - `node --version` prints ≥ v18 (target v20 LTS if provided by container).
   - `npm --version` is available. No global installs run by default.

4. Optional Rust toolchain (only if required by canister/tooling)
   - When `CODEX_SETUP_RUST=true`, `rustc --version` and `cargo --version` are available.
   - Default is off to keep setup fast/lightweight.

5. Agent-safe, cache-aware, and guarded network use
   - Heavy installs only run in the Codex Environment Setup Script and respect `CODEX_SETUP_*` toggles.
   - Agents run without ad-hoc network fetches; post-setup tasks rely on cached tools.
   - No secrets/keys are committed; README/AGENTS.md reference env var usage and CI secrets.

6. Documentation & shortcuts
   - `docs/Codex-Cloud-Environment.md` updated with new toggles and validation steps.
   - Chat shortcuts for develop/QA reference this story.

## Dependencies

- 0.12 Configure project for OpenAI Codex Cloud Environments
- 0.5 ICP service layer bootstrap (context for Motoko/DFX readiness)

## Tasks / Subtasks

- [ ] Extend `scripts/codex_setup.sh` with guarded installers:
  - Add toggles: `CODEX_SETUP_MOTOKO`, `CODEX_SETUP_RUST` (default false).
  - Install DFX + Motoko only when `CODEX_SETUP_MOTOKO=true`.
  - Optionally ensure Node.js ≥18 (use system-provided when present; avoid heavy Node managers by default).
- [ ] Update `docs/Codex-Cloud-Environment.md`:
  - Document new toggles, expected versions, and verification commands.
  - Note caching behavior and how to reset cache when setup changes.
- [ ] Add a lightweight verification script `scripts/codex_verify.sh`:
  - Checks presence/versions of Flutter/Dart, DFX/Motoko, Node, optional Rust.
  - Non-zero exit if required tools (Flutter/Dart) are missing; soft-warn for optional toggles.
- [ ] Validate in a Codex Cloud Environment session:
  - Run setup with Flutter only (default), confirm gates pass in `crypto_market`.
  - Re-run with `CODEX_SETUP_MOTOKO=true` and confirm `dfx`/`moc` are available.
  - If needed, test `CODEX_SETUP_RUST=true` for canister toolchains.
- [ ] Cross-link from `AGENTS.md` to toggles and verification script.

## BDD Scenarios

- Scenario: Flutter-only setup (default)
  - Given the Setup Script runs with default toggles,
  - When the agent executes `dart format`, `flutter analyze`, `flutter test --no-pub` in `crypto_market`,
  - Then all commands are available and run without network dependence.

- Scenario: Motoko enabled via toggle
  - Given `CODEX_SETUP_MOTOKO=true` in the environment config,
  - When the Setup Script runs,
  - Then `dfx --version` and `moc --version` are available, and re-running setup is idempotent.

- Scenario: Rust toolchain opt-in
  - Given `CODEX_SETUP_RUST=true` in the environment config,
  - When the Setup Script runs,
  - Then `rustc --version` and `cargo --version` succeed, with no changes when re-run.

## Testing

1) Flutter/Dart in `crypto_market` (required)
   - `dart format --output=none --set-exit-if-changed .`
   - `flutter analyze --fatal-infos --fatal-warnings`
   - `flutter test --no-pub`

2) Motoko/DFX (when enabled)
   - `dfx --version`
   - `moc --version`
   - Optional: compile a trivial Motoko canister in a temp dir to validate toolchain wiring.

3) Node parity
   - `node --version` (≥ v18), `npm --version`

4) Optional Rust (when enabled)
   - `rustc --version`, `cargo --version`

## Change Log

| Date       | Version | Description                                           | Author |
| ---------- | ------- | ----------------------------------------------------- | ------ |
| YYYY-MM-DD | 0.1     | Initial draft — multi-language Codex Cloud tooling.  | Dev    |

## Dev Agent Record

- Plan: extend `scripts/codex_setup.sh` with opt-in installers and add `scripts/codex_verify.sh`.
- Validate defaults (Flutter-only) first, then Motoko opt-in. Keep setup fast by default.
- Respect guardrails: no secrets in repo; network used only in Setup Script and only with explicit toggles.

## QA Results

- Pending — Verify ACs with Flutter-only setup, then with Motoko toggle on. Ensure idempotency and cache behavior.

## References

- Codex Cloud Environments: https://developers.openai.com/codex/cloud/environments
- Existing setup: `scripts/codex_setup.sh`, `docs/Codex-Cloud-Environment.md`

## Chat Shortcuts (Examples)

- dev *develop [0.13.codex-cloud-multi-language-tooling.md](docs/stories/0.13.codex-cloud-multi-language-tooling.md)
- qa *review [0.13.codex-cloud-multi-language-tooling.md](docs/stories/0.13.codex-cloud-multi-language-tooling.md)

# Story 0.9.12: Copilot Review integration and workflow consolidation

## Status
Draft

## Dependencies

- 0.9.6 Policy and docs
- 0.9.7 Guardrails and quality gates
- 0.9.11 Main merge gate (develop with label)
- References: `AGENTS.md`, `docs/architecture/development-workflow.md`, `.github/workflows/*`

## Story

As a repo maintainer, I want to adopt GitHub Copilot Review for PR review/summarization and retire redundant “comment-only” automation, so that reviews are clearer with less noise while preserving our strict CI gates, guardrails, and merge policies.

## Acceptance Criteria

1. Preserve all hard gates and policies (unchanged):
   - Required checks remain: Workflow Lint / lint, PR Lint / pr-lint, Flutter CI / build-and-test, QA Gate / qa-approved.
   - Label authority (`qa:approved`) stays enforced by `.github/workflows/label-guard.yml`.
   - Auto-PR and auto-merge flows continue to operate, gated by QA + checks.
2. Retire or disable redundant review/summary automation in favor of Copilot Review:
   - In `.github/workflows/reusable-auto-pr.yml`:
     - Skip PR body injection of the “Validation Report” section (the steps that compute CI status and write `<!-- validation:begin --> ... <!-- validation:end -->`).
     - Skip the auxiliary “Auto-approve PR (bot review)” step (which currently just builds another validation summary and is not actual approval by default).
     - Keep PR creation, label management (`automerge-candidate`, `automerge-ok`, `qa:approved`, `ci:validated` if desired), and auto-merge enablement logic intact.
   - In `.github/workflows/enforce-required-checks.yml`:
     - Keep the enforcement job that applies required branch protection contexts.
     - Disable the “Report PR required checks” job that comments/labels `checks:red` for missing/failing checks (UI already shows this; Copilot Review covers narrative feedback).
   - Remove or disable `.github/workflows/qa-gate-producer.yml` (notice-only). Keep `.github/workflows/qa-gate.yml` (required status) and `.github/workflows/label-guard.yml`.
3. Documentation updates:
   - `AGENTS.md` and `docs/architecture/development-workflow.md` mention Copilot Review as the default PR review assistant and note the retired comment-injection behavior.
   - `./.github/pull_request_template.md` removes expectations about auto-injected validation sections; adds a note that Copilot Review will provide a summary/suggestions.
4. Configuration:
   - Introduce repo variable `COPILOT_REVIEW_ENABLED` (default `true`). When `true`, workflows conditionally skip the retired steps above.
   - No new secrets required; keep the ban on `actions/github-script` intact.
5. Verification (one test PR to `develop` from `story/*`):
   - Copilot Review posts a review (summary/suggestions) on the PR.
   - No duplicate “Validation Report” block appears in the PR body.
   - Required checks still gate merge; `qa:approved` still required to merge.
   - Merge-on-green fallback continues to work after QA approval.

## Non-Goals

- Do not change CI gates (`flutter analyze`, `dart format`, `flutter test`).
- Do not change branch naming, PR lint, or QA authority.
- Do not mandate Copilot Review as a required check (unless GitHub exposes a reliable status check for it that we explicitly decide to require later).

## Tasks / Subtasks

- Add `COPILOT_REVIEW_ENABLED` repo variable and wire conditional guards:
  - `.github/workflows/reusable-auto-pr.yml`
    - Skip steps: “Compute CI status and produce validation artifacts” and “Auto-approve PR (bot review)” when `COPILOT_REVIEW_ENABLED == 'true'`.
  - `.github/workflows/enforce-required-checks.yml`
    - Disable the “Report PR required checks” job when `COPILOT_REVIEW_ENABLED == 'true'`.
  - Remove/disable `.github/workflows/qa-gate-producer.yml` (or guard behind `vars.COPILOT_REVIEW_ENABLED != 'true'`).
- Update documentation:
  - `AGENTS.md`: Add Copilot Review notes; clarify that human QA remains authoritative; ban on secrets unchanged.
  - `docs/architecture/development-workflow.md`: Replace references to PR body validation blocks with Copilot Review; confirm required checks list.
  - `.github/pull_request_template.md`: Note Copilot Review will provide an AI review; remove mention of auto-injected validation block.
- Optional cleanup:
  - If `ci:validated` label is not used for any automation decisions, consider removing its application to reduce label noise.

## Testing

- Open a test PR from `story/<id>-<slug>` to `develop` and verify:
  - Copilot Review appears and posts a review.
  - No validation section is injected into the PR body by workflows.
  - Required checks still run and block merge until green.
  - Applying `qa:approved` still enables merge-on-green flow.

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft | Scrum Master |

## Dev Agent Record

- Planned changes only; not yet implemented.
- File List (planned):
  - `.github/workflows/reusable-auto-pr.yml` (conditionalize/skip validation body injection steps)
  - `.github/workflows/enforce-required-checks.yml` (disable reporting job)
  - `.github/workflows/qa-gate-producer.yml` (disable/remove)
  - `AGENTS.md`, `docs/architecture/development-workflow.md`, `.github/pull_request_template.md` (docs updates)

## QA Results

- Pending implementation; to be filled after test PR verification.

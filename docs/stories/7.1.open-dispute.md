# Story 7.1: Open dispute (manual moderation)

## Status
Review

## Dependencies

- 0.5 ICP service layer bootstrap
- 0.7 Auth skeleton (UI-only)
- 0.6 Logging & error handling baseline
- 0.8 Security baseline
- 1.1 Register with email/social
- 3.1 Initiate swap (HTLC)

## Story

As a buyer or seller, I want to open a dispute if payment and release are inconsistent.

## Acceptance Criteria

1. Given an active trade, when I open a dispute, then a case is created and assigned for moderation. [Source: prd/4b-user-stories-and-acceptance.md#e7-disputes-mvp-manual]

### BDD Scenarios

- Scenario: Dispute opened successfully
  - Given I am authenticated and there is an active swap
  - When I provide a dispute reason and submit
  - Then the Atomic Swap canister flags the swap as disputed and returns confirmation
  - And the system notifies the off-chain moderator

- Scenario: Invalid dispute attempt
  - Given the swap is completed or cancelled
  - When I try to open a dispute
  - Then the action is rejected with a clear error

## Tasks / Subtasks

- [ ] Frontend: Dispute UI and provider (AC: 1)
  - [ ] Add dispute initiation UI on `SwapDetailScreen` with reason entry. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Provider handles submission state and error mapping. [Source: architecture/frontend-architecture.md#state-management-architecture]

- [ ] Frontend: Service layer integration (AC: 1)
  - [ ] Call `AtomicSwapService.initiateDispute(swapId, reason)` via ICP service. [Source: architecture/api-specification.md#icp-candid-interface]
  - [ ] Append dev diagnostics to debug log in dev builds when disputes are opened. [Source: architecture/coding-standards.md#logging-&-observability]

- [ ] Backend: Atomic Swap canister implements dispute lifecycle (AC: 1)
  - [ ] Implement/confirm `initiateDispute` and `resolveDispute` per spec. [Source: architecture/api-specification.md#icp-candid-interface]
  - [ ] Notify off-chain moderation channel with context (out-of-scope canister; app-triggered webhook or log). [Source: architecture/core-workflows.md#dispute-resolution-flow-mvp]

- [ ] Security: Authorization and rate limiting (AC: 1)
  - [ ] Validate caller is buyer or seller on the swap; enforce rate limiting. [Source: architecture/coding-standards.md#critical-fullstack-rules]

- [ ] Testing: Unit, widget, and integration tests (AC: 1)
  - [ ] Widget test for dispute form and success/error states. [Source: architecture/testing-strategy.md#test-organization]
  - [ ] Canister unit tests for dispute initiation and resolution. [Source: architecture/testing-strategy.md#test-organization]

- [ ] **Localization: Implement multi-language support for dispute form labels, reason options, confirmation dialogs, status updates, and moderation-related user notifications.**
- [ ] **Logging: Implement debug logging for dispute initiation attempts, reason submissions, swap status validation, moderation notifications, and dispute resolution events. Ensure logging is disabled in production flavors and only active in development/staging builds.**

## Dev Notes

### Previous Story Insights

- This builds on initiated swaps from 3.1; only active swaps are eligible for disputes. [Source: architecture/core-workflows.md#dispute-resolution-flow-mvp]

### Data Models

- Atomic Swap status includes `#disputed`. [Source: architecture/api-specification.md#atomic-swap-types]

### API Specifications

- Atomic Swap canister: `initiateDispute(swapId, reason) -> Result<(), Text>`, `resolveDispute(swapId, resolution) -> Result<(), Text>`. [Source: architecture/api-specification.md#icp-candid-interface]

### Component Specifications

- Frontend: Dispute UI within trading feature, screen `swap_detail_screen.dart`. [Source: architecture/frontend-architecture.md#flutter-app-structure]
- Backend: Atomic Swap canister updates status and logs dispute for moderation. [Source: architecture/components.md#atomic-swap-canister]

### File Locations

- Flutter feature at `lib/features/trading/`; service calls in `lib/core/blockchain/icp_service.dart` and `lib/core/.../atomic_swap_service.dart`. [Source: architecture/frontend-architecture.md#frontend-services-layer]

### Testing Requirements

- Tests cover successful open, invalid status rejection, and authorization checks. [Source: architecture/testing-strategy.md#test-organization]

### Technical Constraints

- Enforce coding standards for error handling, principal validation, and logging discipline. [Source: architecture/coding-standards.md#project-baseline-standards-flutter-dart]

### Core Workflows

- Follow Dispute Resolution flow including canister status update and admin notification. [Source: architecture/core-workflows.md#dispute-resolution-flow-mvp]

### Project Structure Notes

- Treat moderation as off-chain for MVP; canister only flags and records disputes. [Source: architecture/core-workflows.md#dispute-resolution-flow-mvp]

## Testing

- Verify:
  - Dispute opens only on active swaps.
  - UI shows confirmation and status updates.
  - Unauthorized attempts are rejected.

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft created for Story 7.1 | Scrum Master |

## Dev Agent Record

- Agent Model Used: _TBD_
- Debug Log References: _TBD_
- Completion Notes List: _TBD_
- File List: _TBD_

## QA Results

_TBD_



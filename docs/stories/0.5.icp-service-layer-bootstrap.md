# Story 0.5: ICP service layer bootstrap

## Status
Done

## Dependencies

- 0.3 Config & secrets
- 0.4 App structure alignment

## Story

As a developer, I want an ICP service layer with canister client stubs and error mapping, so that features can call canisters through a stable API.

## Acceptance Criteria

1. `ICPService` skeleton exists with initialization hooks for market, user_management, atomic_swap, price_oracle. [Source: docs/architecture/frontend-architecture.md#frontend-services-layer]
2. Initial methods available: `register(email, password, username)`, `loginWithOAuth(provider, token)`, `getUserProfile(principal)`. [Source: docs/architecture/api-specification.md#icp-candid-interface]
3. Result errors mapped to domain errors (e.g., `AuthError { invalidCredentials, oauthDenied, network, unknown }`). [Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
4. Service is injected into `auth` and `market` providers. [Source: docs/architecture/frontend-architecture.md#state-management-architecture]

### BDD Scenarios

- Scenario: Registration call returns a domain result
  - Given `ICPService` is initialized
  - When I call `register(email, password, username)`
  - Then I receive a typed Result and errors are mapped to `AuthError`

-- Scenario: Service injection available to features
  - Given the `auth` and `market` providers
  - When the app starts
  - Then the service is injected and available to those providers

## Tasks / Subtasks

- [x] Create `lib/core/blockchain/icp_service.dart` skeleton with actor init. (AC: 1)
- [x] Implement `register`, `loginWithOAuth`, `getUserProfile` stubs. (AC: 2)
- [x] Add error mapping utilities and `AuthError` enum/class. (AC: 3)
- [x] Wire into providers for `auth` and `market` features. (AC: 4)

## Dev Notes

- Use the interface patterns shown (actor initialization and typed mapping). [Source: docs/architecture/frontend-architecture.md#frontend-services-layer]
- Follow Candid type definitions for request/response shapes. [Source: docs/architecture/api-specification.md#icp-candid-interface]

## Testing

- Unit tests verify actor initialization and error mapping (`AuthError`) paths. [Source: docs/architecture/testing-strategy.md#test-organization]
- Widget test: auth flow uses injected service without runtime errors (mocked service provider).

## Key Files to Create/Modify

- `crypto_market/lib/core/blockchain/icp_service.dart` (actor init + stubs)
- `crypto_market/lib/core/blockchain/errors.dart` (e.g., `AuthError` and mapping)
- Providers: `crypto_market/lib/features/auth/providers/` and `crypto_market/lib/features/market/providers/`

## References

- `docs/architecture/frontend-architecture.md#frontend-services-layer`
- `docs/architecture/api-specification.md#icp-candid-interface`

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft for ICP service layer | Scrum Master |
| 2025-08-14 | 0.2 | QA: Changes requested â€” AC1 (actor init) and AC3 (error mapping) not met; add tests for mapping and DI wiring | QA |
| 2025-08-14 | 0.3 | Dev: Implemented actors, error mapping, DI wiring; added unit/widget tests; local gates passed | Dev |

## Dev Agent Record

- Agent Model Used: GPT-5 (Cursor)
- Debug Log References: Implemented actor fields and init, error mapping, tests added; ran format/analyze/tests locally green
- Completion Notes List:
  - Added explicit actor placeholders for market, user_management, atomic_swap, price_oracle initialized from `AppConfig`
  - Implemented error mapping utilities and integrated into service methods
  - Added unit tests for actor initialization and error mapping; added widget test to verify DI wiring
  - Ran local quality gates: format, analyze (no issues), tests (all passed)
- File List:
  - Modified: `crypto_market/lib/core/blockchain/icp_service.dart`
  - Modified: `crypto_market/lib/core/blockchain/errors.dart`
  - Modified: `crypto_market/test/unit/icp_service_test.dart`
  - Added: `crypto_market/test/widget/icp_di_wiring_test.dart`

## QA Results

 - Verification summary:
   - `lib/core/blockchain/icp_service.dart`: Factory `fromConfig` initializes explicit actor placeholders for `market`, `userManagement`, `atomicSwap`, `priceOracle` from `AppConfig` canister IDs. Methods `register`, `loginWithOAuth`, `getUserProfile` present and return typed `Result` with mapped error paths.
   - `lib/core/blockchain/errors.dart`: `Result` type present; `AuthError { invalidCredentials, oauthDenied, network, unknown }` defined; mapping utilities added (`AuthInvalidCredentialsException`, `OAuthDeniedException`, `mapAuthException`).
   - Providers: `lib/features/auth/providers/auth_service_provider.dart` and `lib/features/market/providers/market_service_provider.dart` accept `ICPService` via constructor.
   - App wiring: `lib/main.dart` injects a single `ICPService` instance into both providers via `MultiRepositoryProvider`.
   - Tests: `test/unit/icp_service_test.dart` covers actor initialization and error mapping; `test/widget/icp_di_wiring_test.dart` verifies DI wiring without runtime errors. All tests pass locally.

 - Findings:
   - Status: Met
   - Evidence by AC:
     - AC1: Explicit actor fields and initialization implemented. [Met]
     - AC2: Required method stubs implemented. [Met]
     - AC3: Error mapping utilities implemented and integrated into service methods. [Met]
     - AC4: Service injected into `auth` and `market` providers at app startup. [Met]

 - Re-test checklist:
   - Service methods return typed `Result` values with proper error mapping across failure cases. [Pass]
   - Providers resolve via app-level injection without runtime errors. [Pass]
   - Local analyze/tests pass. [Pass]


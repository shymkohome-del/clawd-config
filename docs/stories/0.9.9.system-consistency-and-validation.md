Title: Story 0.9.9 — System consistency and end-to-end validation
Status: InProgress

# Story 0.9.9: Consistency check and full end-to-end validation

## Story

As a maintainer, I want a single story that executes a comprehensive consistency check across all PR automation paths so that the system is provably deterministic, resilient, and policy-compliant before closing the epic.

## Acceptance Criteria

1. End-to-end coverage: green runs across reusable wrapper path and fallback merge-on-green path for both `feature/*` and `story/*` (with `Status: Done`).
2. Failure injection coverage: simulated API `502/503`, rate-limit with `Retry-After`, insufficient permissions (`403`), repo `allow_auto_merge=false`, unsupported branch, and missing story file—all handled gracefully with standardized `reason` keys and summaries.
3. Unified reason taxonomy is enforced and documented: `unsupported-branch`, `status-not-done`, `story-file-missing`, `insufficient-permissions`, `repo-allow-auto-merge-disabled`, `graphql-error`, `no-open-pr`.
4. Required-checks enforcement verified by scheduled run; step summary lists required contexts enforced for `main` and `develop`.
5. Self-test matrix includes: feature, story-done, story-not-done, unsupported, and missing-story-file cases; each emits a clear decision summary.
6. Documentation updated in `docs/architecture/development-workflow.md` with troubleshooting and reason taxonomy.
7. Stability: three consecutive successful matrix runs without flakes and with consistent summaries.

## Dependencies

- 0.9.1 Workflow lint and flags
- 0.9.2 Deterministic PR creation
- 0.9.3 Auto-merge that actually merges
- 0.9.4 Reliability hardening
- 0.9.5 Reusable and testable design
- 0.9.6 Policy and docs
- 0.9.7 Guardrails and quality gates
- 0.9.8 Cleanup and metrics

## Tasks / Subtasks

- [ ] Expand `auto-pr-self-test.yml` matrix with cases: feature, story-done, story-not-done, unsupported-branch, missing-story-file.
- [ ] Wire `scripts/retry.sh` into all REST/GraphQL calls (reusable and fallback) to handle 5xx/timeouts/rate-limit with `Retry-After`.
- [ ] Introduce controlled failure injection flags (e.g., env `INJECT_502`, `INJECT_RATE_LIMIT`, `INJECT_403`) to simulate API outcomes in self-tests without affecting production runs.
- [ ] Normalize reason keys across reusable and fallback flows and surface them in `$GITHUB_OUTPUT` and final summaries.
- [ ] Ensure required-checks enforcement workflow emits summary of contexts and passes a weekly schedule run.
- [ ] Update `docs/architecture/development-workflow.md` with reason taxonomy, flags, troubleshooting steps, and how to re-run enforcement.
- [ ] Add link-check step or manual verification to ensure docs links resolve.
- [ ] Produce a short QA checklist accompanying summaries for reviewers.
- [ ] Execute the “Additional: Consistency & Test Plan” sections for stories `0.9.1`–`0.9.8` and attach evidence (links to runs, summaries) in this story’s Dev Agent Record.

## BDD Scenarios

- Scenario: Zero-touch PR lifecycle (feature)
  - Given a push to `feature/x`
  - When the workflows run
  - Then a PR is created or reused deterministically and merges when checks pass

- Scenario: Zero-touch PR lifecycle (story done)
  - Given a push to `story/<id>-slug` with `Status: Done` in the story file
  - When the workflows run
  - Then a PR is created or reused deterministically, auto-merge is enabled or fallback merges, and branch is cleaned up

- Scenario: Story not done gate
  - Given a `story/<id>-slug` with `Status:` not equal to Done
  - When the workflows run
  - Then PR creation is skipped with `reason=status-not-done` and clear summary

- Scenario: Failure injection (API 502)
  - Given a transient API 502 during PR query
  - When retry/backoff executes
  - Then the call succeeds and the run continues; summaries reflect retries

- Scenario: Missing story file
  - Given a `story/<id>-slug` branch without a corresponding story file
  - When the workflows run
  - Then execution is skipped with `reason=story-file-missing`

## Testing

- Run self-tests matrix and verify each case's summary includes branch meta, action taken, and reason key.
- Inject `502`/`503` and rate-limit to validate backoff and `Retry-After` handling; verify max-attempts behavior and taxonomy.
- Temporarily disable permissions (`403`) to confirm graceful handling with `reason=insufficient-permissions`.
- Toggle repo `allow_auto_merge=false` (or simulate) and verify `reason=repo-allow-auto-merge-disabled` with fallback path still merging on green.
- Confirm scheduled enforcement sets required contexts on `main` and `develop` and logs them in summary.
- Ensure three consecutive green runs with identical summaries for the same scenarios.

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft | Scrum Master |

## Dev Agent Record

- Implemented: TBA
- Evidence: TBA

## QA Results

- Results: TBA


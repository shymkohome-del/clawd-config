Title: Story 0.9.11 — Main merge gate (develop + label)
Status: Done

# Story 0.9.11: Only allow develop → main merges with a release label

## Story

As a repo maintainer, I want merges into `main` to be allowed only from the `develop` branch and only when a specific release label is present, so that production releases are controlled, auditable, and protected from accidental merges.

## Acceptance Criteria

1. Eligibility: Only PRs with base `main` and head `develop` are eligible to merge; all other base/head combinations to `main` are blocked by a required check.
2. Label gate: Eligible PRs must include label `release:approved` (configurable) to pass the gate.
3. Required check: A CI job named `main-release-gate` evaluates eligibility and label; when conditions are unmet it fails with a clear, actionable message; when met it passes. It runs only for PRs targeting `main`.
4. Guardrails: No use of `actions/github-script`; no secrets printed; adheres to existing repo guardrails in `AGENTS.md`.
5. Branch protection: `main` requires `main-release-gate` and existing CI checks, enforces squash merges only, and disallows direct pushes.
6. Documentation: Release flow is documented (how to open `develop` → `main` PR and apply the release label) and cross‑linked from `AGENTS.md`.

## Dependencies

- 0.9.7 Guardrails and quality gates
- 0.9.3 Auto‑merge enablement and repo settings alignment
- 0.9.2 Deterministic PR creation

## Tasks / Subtasks

- [x] Add workflow `.github/workflows/main-release-gate.yml` that:
  - Runs on `pull_request` targeting `main`.
  - Fails unless `github.base_ref == 'main' && github.head_ref == 'develop' && label == 'release:approved'`.
  - Emits clear failure reasons: `wrong-head`, `missing-label`, or `ok`.
- [x] Mark `main-release-gate` as a required status check in `main` branch protection (squash only; disallow direct push).
- [x] Document release process in `docs/architecture/development-workflow.md` and reference from `AGENTS.md`.
- [x] Add chat shortcut examples for opening the release PR (develop → main) and applying the label.

## BDD Scenarios

- Scenario: develop → main with release label
  - Given a PR with base `main` and head `develop`
  - And the label `release:approved` is applied
  - When CI runs
  - Then the `main-release-gate` check passes and the PR can merge when other checks are green

- Scenario: develop → main without release label
  - Given a PR with base `main` and head `develop`
  - And the release label is not present
  - When CI runs
  - Then the `main-release-gate` check fails with reason `missing-label`

- Scenario: feature → main is blocked
  - Given a PR with base `main` and head `feature/foo`
  - When CI runs
  - Then the `main-release-gate` check fails with reason `wrong-head`

## Testing

- Open a test PR from `develop` to `main` without the label and confirm the gate fails with a clear message.
- Apply the `release:approved` label; confirm the gate passes while all standard CI checks (format/analyze/test) still run and must pass.
- Attempt a PR from a non‑`develop` head to `main`; confirm the gate fails and prevents merge.

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY‑MM‑DD | 0.1 | Initial draft — SM story for main merge gate (develop + label). | Scrum Master |

## Dev Agent Record

- Planned implementation:
  - Add `main-release-gate` workflow to evaluate base/head and label.
  - Ensure the job is required on `main` branch protection; keep actions minimal and compliant with guardrails (no `actions/github-script`).
  - Update release documentation and cross‑link from `AGENTS.md`.

## QA Results

- `dart format --output=none --set-exit-if-changed .` (formatted files)
- `flutter analyze --fatal-infos --fatal-warnings`
- `flutter test --no-pub`

## Chat Shortcuts (Examples)

- dev *develop [0.9.11.main-merge-gate-develop-with-label.md](docs/stories/0.9.11.main-merge-gate-develop-with-label.md)
- qa *review [0.9.11.main-merge-gate-develop-with-label.md](docs/stories/0.9.11.main-merge-gate-develop-with-label.md)

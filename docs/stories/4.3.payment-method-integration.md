# Story 4.3: Payment method integration and validation

## Status
Ready for Review

## Dependencies

- 1.1 Register with email/social
- 2.6 Buy listing - Complete trade initiation flow
- 3.1 Initiate swap (HTLC)
- 0.6 Logging and error handling baseline
- 0.8 Security baseline

## Story

As a buyer, I want to securely add and validate payment methods (bank transfer, digital wallet, cash) so that I can complete real transactions with sellers through the atomic swap process.

## Acceptance Criteria

1. Given I am in a trade flow, when I select a payment method, then I can add bank account, digital wallet, or cash details with proper validation. [Source: prd/4-functional-requirements.md#44-payment-methods]
2. Given I add payment method details, when I submit them, then they are securely stored and can be reused for future trades. [Source: prd/5-non-functional-requirements.md#52-security-requirements]
3. Given a payment method is selected, when the atomic swap reaches payment phase, then I see clear instructions for completing the off-chain payment. [Source: architecture/core-workflows.md#atomic-swap-flow]
4. Given I complete the off-chain payment, when I submit proof, then the seller is notified and can confirm receipt before releasing the atomic swap. [Source: prd/4-functional-requirements.md#44-payment-methods]

### BDD Scenarios

- Scenario: Add bank transfer payment method
  - Given I am authenticated and in a trade flow
  - When I select "Bank Transfer" as payment method
  - Then I can enter bank account details (account number, routing number, beneficiary name)
  - And the details are validated for format correctness
  - And they are securely encrypted and stored for reuse

- Scenario: Digital wallet payment method
  - Given I am selecting payment methods
  - When I choose digital wallet (PayPal, Wise, etc.)
  - Then I can enter wallet identifier and verify ownership
  - And the system validates the wallet format
  - And stores the verified payment method

- Scenario: Cash payment coordination
  - Given I select cash payment for a local trade
  - When I proceed with the payment setup
  - Then I can specify meeting location preferences and availability
  - And both parties receive coordination instructions

- Scenario: Payment proof submission
  - Given I have completed an off-chain payment
  - When I submit payment proof (receipt, transaction ID, photo)
  - Then the proof is uploaded to IPFS and linked to the atomic swap
  - And the seller receives notification to verify and confirm

## Tasks / Subtasks

- [ ] Frontend: Payment Method Management UI (AC: 1, 2)
  - [ ] Create `PaymentMethodsScreen` for managing saved payment methods. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Create `AddPaymentMethodScreen` with forms for bank, wallet, and cash options. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Implement validation for different payment method formats. [Source: architecture/coding-standards.md#input-validation]
  - [ ] **Localization: Implement multi-language support for payment method labels, validation messages, instructions, and error states.**
  - [ ] **Logging: Implement debug logging for payment method management actions, validation events, secure storage operations, trade integration steps, and proof submission processes. Ensure logging is disabled in production flavors and only active in development/staging builds.**

- [ ] Frontend: Payment Method Selection in Trade Flow (AC: 3)
  - [ ] Integrate payment method selection into buy flow from story 2.6. [Source: architecture/frontend-architecture.md#state-management-architecture]
  - [ ] Display payment instructions based on selected method and trade details. [Source: architecture/core-workflows.md#atomic-swap-flow]
  - [ ] Show estimated completion times and requirements for each method. [Source: architecture/frontend-architecture.md#flutter-app-structure]

- [ ] Frontend: Payment Proof Submission (AC: 4)
  - [ ] Create `PaymentProofScreen` with image capture, receipt upload, and transaction ID entry. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Implement image upload to IPFS with compression and validation. [Source: architecture/core-workflows.md#create-listing-flow]
  - [ ] Link payment proof to specific atomic swap and notify seller. [Source: architecture/core-workflows.md#atomic-swap-flow]

- [ ] Backend: Payment Method Storage (AC: 2)
  - [ ] Design secure payment method data model with encryption at rest. [Source: architecture/data-models.md]
  - [ ] Implement payment method CRUD operations in User Management canister. [Source: architecture/api-specification.md#user-management-canister]
  - [ ] Add proper access controls and audit logging for payment method changes. [Source: prd/7-security-architecture.md#72-security-measures]

- [ ] Backend: Payment Validation Services (AC: 1)
  - [ ] Implement bank account format validation for major regions (US, EU, UK). [Source: architecture/coding-standards.md#input-validation]
  - [ ] Add digital wallet identifier validation (email, phone, wallet address formats). [Source: architecture/coding-standards.md#input-validation]
  - [ ] Create location-based validation for cash payment availability. [Source: architecture/backend-architecture.md#canister-based-service-architecture]

- [ ] Backend: Payment Proof Management (AC: 4)
  - [ ] Create payment proof data model linking to atomic swaps. [Source: architecture/data-models.md]
  - [ ] Implement IPFS integration for storing payment evidence securely. [Source: architecture/backend-architecture.md#canister-based-service-architecture]
  - [ ] Add notification triggers when payment proof is submitted. [Source: architecture/core-workflows.md#atomic-swap-flow]

- [ ] Security: Data Protection and Compliance (AC: 2)
  - [ ] Implement PCI-DSS compliant encryption for sensitive payment data. [Source: prd/7-security-architecture.md#72-security-measures]
  - [ ] Add proper key management and rotation for payment method encryption. [Source: prd/7-security-architecture.md#72-security-measures]
  - [ ] Ensure GDPR compliance for payment method deletion and data portability. [Source: prd/8-compliance-and-legal.md#81-regulatory-compliance]

## Dev Notes

### Previous Story Insights
- Story 2.6 established the buy flow UI patterns and state management architecture
- Story 1.1 provides user authentication and principal management foundation
- Story 3.1 defines atomic swap integration points for payment coordination

### Data Models [Source: architecture/data-models.md]
**PaymentMethod Model:**
```typescript
interface PaymentMethod {
  id: string;
  userId: Principal;
  type: 'bank_transfer' | 'digital_wallet' | 'cash';
  encrypted_details: string; // AES encrypted JSON
  display_name: string; // Non-sensitive display info
  is_verified: boolean;
  created_at: bigint;
  last_used: bigint;
}
```

**PaymentProof Model:**
```typescript
interface PaymentProof {
  id: string;
  swap_id: string;
  payment_method_id: string;
  proof_type: 'receipt' | 'transaction_id' | 'photo' | 'confirmation';
  ipfs_hash: string;
  submitted_by: Principal;
  submitted_at: bigint;
  verified_by?: Principal;
  verified_at?: bigint;
}
```

### API Specifications [Source: architecture/api-specification.md]
**User Management Canister - Payment Methods:**
- `addPaymentMethod(method_type: Text, encrypted_details: Text) -> Result<PaymentMethodId, PaymentError>`
- `getPaymentMethods(user: Principal) -> Result<[PaymentMethod], PaymentError>`
- `updatePaymentMethod(id: Text, encrypted_details: Text) -> Result<(), PaymentError>`
- `deletePaymentMethod(id: Text) -> Result<(), PaymentError>`

**Atomic Swap Canister - Payment Integration:**
- `submitPaymentProof(swap_id: Text, proof_ipfs_hash: Text) -> Result<(), SwapError>`
- `getPaymentInstructions(swap_id: Text) -> Result<PaymentInstructions, SwapError>`

### Component Specifications [Source: architecture/frontend-architecture.md]
**File Locations:**
- Payment management: `lib/features/payments/screens/payment_methods_screen.dart`
- Add payment method: `lib/features/payments/screens/add_payment_method_screen.dart`
- Payment proof: `lib/features/trading/screens/payment_proof_screen.dart`
- State management: `lib/features/payments/providers/payment_method_provider.dart`
- Services: `lib/core/services/payment_service.dart`

**State Management Architecture:**
- Use Bloc/Cubit for payment method CRUD operations
- Integrate with existing trade flow state from story 2.6
- Handle secure storage of payment method IDs (not sensitive details)

### Testing Requirements [Source: architecture/testing-strategy.md]
**Unit Tests:**
- Payment method validation logic for different formats
- Encryption/decryption of payment method details
- IPFS upload and retrieval for payment proofs

**Widget Tests:**
- Payment method forms with validation
- Payment proof submission UI
- Payment method selection in trade flows

**Integration Tests:**
- End-to-end payment method lifecycle
- Payment proof submission to IPFS and canister
- Payment method integration with atomic swap flow

**Security Tests:**
- Encryption at rest for sensitive payment data
- Access control for payment method operations
- Data masking in logs and error messages

### Technical Constraints [Source: architecture/coding-standards.md]
- Never store raw payment method details in logs or error messages
- Use AES-256 encryption for all sensitive payment data
- Implement proper key rotation for payment method encryption
- Follow PCI-DSS guidelines for handling payment information
- Ensure payment method deletion is irreversible and complete

### Security Considerations [Source: prd/7-security-architecture.md]
- Payment method details must be encrypted at rest using ICP's encryption capabilities
- Implement rate limiting for payment method operations to prevent abuse
- Add audit logging for all payment method changes and access
- Use secure communication channels for all payment-related data transfer
- Validate payment method ownership before allowing usage in trades

## Testing

### Unit Testing
- Test payment method validation for different formats and regions
- Test encryption/decryption of payment method details
- Test IPFS upload/download for payment proofs
- Test error handling for invalid payment methods

### Widget Testing
- Test payment method management screens and flows
- Test payment method selection in trade context
- Test payment proof submission UI and validation
- Test accessibility and localization

### Integration Testing
- Test complete payment method lifecycle from creation to usage
- Test payment proof submission and seller notification flow
- Test integration between payment methods and atomic swap process
- Test error recovery and rollback scenarios

### Security Testing
- Verify encryption of sensitive payment data
- Test access controls for payment method operations
- Validate audit logging and compliance measures
- Test payment method deletion and data cleanup

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | 1.0 | Initial story creation for payment method integration | SM |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent during review*
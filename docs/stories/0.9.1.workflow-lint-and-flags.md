Title: Story 0.9.1 — Workflow lint and feature flags
Status: Done

# Story 0.9.1: Stabilize and make failures impossible to miss

## Story

As a repo maintainer, I want workflows to fail fast on syntax/format issues and to be toggleable via flags, so that riskier automation can be enabled/disabled without code changes and broken YAML never ships silently.

## Acceptance Criteria

1. A required check named "Workflow Lint" runs before other jobs and fails on any YAML/action issues using `actionlint` and `yamllint`.
2. All bash steps run with `set -euo pipefail`; missing env/vars cause failures with clear messages.
3. Feature flags via repo variables: `AUTO_PR_ENABLED`, `AUTO_MERGE_ENABLED` (default true when unset). Toggling flags enables/disables behavior without code changes.
4. Any YAML mistake blocks the workflow with a clear, actionable error message.

## Dependencies

- 0.1 Repo & CI baseline

## Tasks / Subtasks

- [ ] Add job `workflow-lint` to `.github/workflows/auto-pr-from-qa.yml` running:
  - `uses: actions/checkout@v4` (pinned)
  - Install `actionlint` and `yamllint` (pinned versions) and run against `.github/workflows/**.yml`.
  - Mark this job as a required status check named "Workflow Lint" in repo settings.
- [x] Enforce `set -euo pipefail` in all bash `run:` blocks within the workflow.
- [x] Introduce flags by gating subsequent jobs/steps with `${{ vars.AUTO_PR_ENABLED != 'false' }}` and `${{ vars.AUTO_MERGE_ENABLED != 'false' }}`.
- [x] Add clear echo messages when a flag disables behavior (non‑failing, with rationale).

## BDD Scenarios

- Scenario: Lint blocks invalid YAML
  - Given a malformed workflow YAML is committed
  - When the `workflow-lint` job runs
  - Then the job fails with a clear error and no subsequent jobs run

- Scenario: Flags disable automation without code changes
  - Given `AUTO_PR_ENABLED` is set to `false`
  - When the workflow runs on a valid branch
  - Then PR creation steps are skipped with a clear note in logs

## Testing

- Commit a deliberately malformed YAML change in a branch and observe `workflow-lint` fails and blocks.
- Set repo variable `AUTO_PR_ENABLED=false` and verify PR creation step is skipped; set back to `true` and verify it runs.

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY‑MM‑DD | 0.1 | Initial draft | Scrum Master |
| 2025-08-18 | 0.2 | QA: Changes requested — AC1 pending (mark "Workflow Lint" as required check in branch protection for main/develop). | QA |
| 2025-08-18 | 0.3 | QA: Added automated enforcement workflow `.github/workflows/enforce-required-checks.yml` to self-heal required check. Requires `REPO_ADMIN_TOKEN` secret once. | QA |
| 2025-08-18 | 0.4 | QA: Review logged — AC2–AC4 Pass; AC1 pending enforcement. Recommend requiring checks: "Workflow Lint / lint" and "Auto PR and Auto-merge on QA Done / Workflow Lint" in branch protection. | QA |
| 2025-08-18 | 0.5 | QA: Re-review — Enforcement workflow already enforces both contexts; awaiting `REPO_ADMIN_TOKEN` to apply required checks on main/develop. AC1 remains Partial until applied. | QA |
| 2025-08-18 | 0.6 | QA: Token present — proceed to run enforcement and verify branch protection on `main`/`develop`. | QA |
| 2025-08-18 | 0.7 | QA: Verified required checks present on `main` and `develop` — AC1 Pass. Status set to Done. | QA |

## Dev Agent Record

- Implemented:
  - Added `Workflow Lint` pre-job in `.github/workflows/auto-pr-from-qa.yml`
  - Added separate PR-triggered `workflow-lint.yml`
  - Enforced `set -euo pipefail` in bash steps
  - Feature flags added: `AUTO_PR_ENABLED`, `AUTO_MERGE_ENABLED`, `AUTO_APPROVE_ENABLED`
  - Updated enforcement workflow to require two contexts in branch protection:
    - "Workflow Lint / lint"
    - "Auto PR and Auto-merge on QA Done / Workflow Lint"
-

## QA Results

- AC1 — Workflow Lint pre-job: Pass. Linting implemented (`actionlint` + `yamllint --strict`) and enforced as a dependency. Branch protection on `main` and `develop` requires:
  - "Workflow Lint / lint"
  - "Auto PR and Auto-merge on QA Done / Workflow Lint"
- AC2 — Bash safety: Pass. All bash `run:` blocks include `set -euo pipefail`.
- AC3 — Feature flags: Pass. Gated via `${{ vars.AUTO_PR_ENABLED != 'false' }}` and `${{ vars.AUTO_MERGE_ENABLED != 'false' }}` with clear skip notes. Extra `AUTO_APPROVE_ENABLED` present (non-breaking).
- AC4 — YAML mistakes block: Pass. Lint jobs fail invalid YAML with actionable errors.

Additional notes:
- Branch protection currently also lists the legacy context "Workflow Lint" in addition to the two required contexts above; this is acceptable.

Verdict: All ACs Pass. `Status: Done`.



## Additional: Consistency & Test Plan

- Guardrails and enforcement:
  - Schedule weekly run of `enforce-required-checks.yml` to self-heal required contexts on `main`/`develop`.
  - Verify required contexts include both "Workflow Lint / lint" and the wrapper's pre-lint name as configured.
- Failure injection tests:
  - Commit a malformed workflow YAML and confirm `actionlint`/`yamllint --strict` fail early and block downstream jobs.
  - Remove required checks from branch protection manually and confirm enforcement workflow restores them on next run.
  - Toggle `AUTO_PR_ENABLED=false` and `AUTO_MERGE_ENABLED=false` and confirm clear, non-failing skip notes.
- Determinism checks:
  - Re-run the same commit and confirm lint job remains deterministic (no flakes across 3 runs).
- Observability:
  - Ensure lint job writes a brief step summary with versions of `actionlint`/`yamllint` used and file counts linted.

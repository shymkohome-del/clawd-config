Title: Story 0.9.5 — Reusable and testable design
Status: Done

# Story 0.9.5: Reusable and testable workflow design

## Story

As a maintainer, I want the PR automation logic extracted into a reusable called workflow with self‑tests, so that we can validate changes without creating real PRs.

## Acceptance Criteria

1. New reusable workflow at `.github/workflows/reusable-auto-pr.yml` exposes inputs/outputs via `workflow_call`.
2. Existing `.github/workflows/auto-pr-from-qa.yml` becomes a thin wrapper that calls the reusable workflow.
3. A self‑test workflow `auto-pr-self-test.yml` runs a matrix of synthetic refs: `feature/x`, `story/1.2-test` with and without `Status: Done`.
4. Local CI preflight job runs `actionlint` and a dry‑run script that validates branch/title/story parsing without network calls.

## Dependencies

- 0.9.4 Reliability hardening

## Tasks / Subtasks

- [x] Create `reusable-auto-pr.yml` with inputs: branch name, flags; outputs: pr_number, decision trace.
- [x] Thin `auto-pr-from-qa.yml` wrapper to call reusable workflow with repo defaults.
- [x] Add `auto-pr-self-test.yml` to exercise scenarios without creating real PRs (use mock mode or dry‑run steps).
- [x] Add a local preflight job in CI running parsing validation script.

## BDD Scenarios

- Scenario: Self‑test validates gating
  - Given matrix entries include a `story/*` with `Status: Done` and one without
  - When self‑tests run
  - Then one path proceeds to PR creation (mocked) and the other is skipped with `reason=status-not-done`

## Testing

- Validate that wrapper passes inputs and collects outputs; ensure summaries render for each matrix case.

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY‑MM‑DD | 0.1 | Initial draft | Scrum Master |
| 2025-08-19 | 0.2 | QA: Sync — No reusable workflow/self-tests/preflight yet; Status InProgress. | QA |
| 2025-08-19 | 0.3 | QA: Updated — Reusable workflow and self-tests added; wrapper not thin and local preflight missing. Status remains InProgress. | QA |
| 2025-08-19 | 0.4 | Dev: Reusable workflow finalized with inputs/outputs and summaries; wrapper defaults to reusable; self-test matrix present. Local preflight parser still pending. Status InProgress. | Dev |
| 2025-08-20 | 0.5 | Dev: Added preflight parser job in wrapper using `scripts/preflight-parse.sh`; wrapper now thin. All ACs satisfied. Set Status to Review. | Dev |
| 2025-08-21 | 0.6 | QA: Accepted — All ACs pass; Status set to Done. | QA |

## Dev Agent Record

- Implemented:
  - Reusable workflow `.github/workflows/reusable-auto-pr.yml` exposes inputs/outputs and summary
  - Wrapper `.github/workflows/auto-pr-from-qa.yml` calls the reusable deterministically
  - Self-test `auto-pr-self-test.yml` runs dry-run matrix
  - Local preflight parser via `scripts/dev-validate.sh` added
  - Validation PR body markers and artifacts added; labels `automerge-*`, `ci:validated`

## QA Results

- AC1 — Reusable workflow: Pass. `.github/workflows/reusable-auto-pr.yml` defines `workflow_call` with inputs (branch, flags) and output `pr_number`.
- AC2 — Wrapper: Pass. `.github/workflows/auto-pr-from-qa.yml` is a thin wrapper that lints, runs preflight parser, and calls the reusable via `uses: ./.github/workflows/reusable-auto-pr.yml`.
- AC3 — Self‑tests: Pass. `.github/workflows/auto-pr-self-test.yml` runs a dry‑run matrix (feature, story done, story not done) and calls the reusable.
- AC4 — Local preflight: Pass. Wrapper contains `preflight-parse` job invoking `scripts/preflight-parse.sh`; no network calls.

Verdict: All ACs met. Status set to Done.



## Additional: Consistency & Test Plan

- Contract tests for `workflow_call`:
  - Validate inputs (`branch`, `enable_auto_merge`, `auto_approve`, `dry_run`) defaults and type coercion; assert outputs include `pr_number` and auto-merge fields.
- Self-test matrix expansion:
  - Add matrix entries for unsupported branch and missing story file; confirm skip with appropriate `reason` keys.
- Wrapper thinness:
  - Ensure `auto-pr-from-qa.yml` contains only lint, preflight, and a single `uses` job; no duplicated logic.
- Preflight script:
  - Run `scripts/preflight-parse.sh` locally with sample branches; ensure no network access and deterministic parsing outcomes.

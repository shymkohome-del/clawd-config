Title: Story 0.9.5 — Reusable and testable design
Status: InProgress

# Story 0.9.5: Reusable and testable workflow design

## Story

As a maintainer, I want the PR automation logic extracted into a reusable called workflow with self‑tests, so that we can validate changes without creating real PRs.

## Acceptance Criteria

1. New reusable workflow at `.github/workflows/reusable-auto-pr.yml` exposes inputs/outputs via `workflow_call`.
2. Existing `.github/workflows/auto-pr-from-qa.yml` becomes a thin wrapper that calls the reusable workflow.
3. A self‑test workflow `auto-pr-self-test.yml` runs a matrix of synthetic refs: `feature/x`, `story/1.2-test` with and without `Status: Done`.
4. Local CI preflight job runs `actionlint` and a dry‑run script that validates branch/title/story parsing without network calls.

## Dependencies

- 0.9.4 Reliability hardening

## Tasks / Subtasks

- [ ] Create `reusable-auto-pr.yml` with inputs: branch name, flags; outputs: pr_number, decision trace.
- [ ] Thin `auto-pr-from-qa.yml` wrapper to call reusable workflow with repo defaults.
- [ ] Add `auto-pr-self-test.yml` to exercise scenarios without creating real PRs (use mock mode or dry‑run steps).
- [ ] Add a local preflight job in CI running parsing validation script.

## BDD Scenarios

- Scenario: Self‑test validates gating
  - Given matrix entries include a `story/*` with `Status: Done` and one without
  - When self‑tests run
  - Then one path proceeds to PR creation (mocked) and the other is skipped with `reason=status-not-done`

## Testing

- Validate that wrapper passes inputs and collects outputs; ensure summaries render for each matrix case.

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY‑MM‑DD | 0.1 | Initial draft | Scrum Master |
| 2025-08-19 | 0.2 | QA: Sync — No reusable workflow/self-tests/preflight yet; Status InProgress. | QA |
| 2025-08-19 | 0.3 | QA: Updated — Reusable workflow and self-tests added; wrapper not thin and local preflight missing. Status remains InProgress. | QA |

## Dev Agent Record

- Current state:
  - Logic primarily in `.github/workflows/auto-pr-from-qa.yml` and `merge-on-green-fallback.yml`
  - No `workflow_call` reusable extraction yet
  - No self-test workflow or local preflight parser yet

## QA Results

- AC1 — Reusable workflow: Pass. `.github/workflows/reusable-auto-pr.yml` exposes inputs/outputs via `workflow_call`.
- AC2 — Wrapper: Partial. Wrapper calls the reusable when `vars.USE_REUSABLE == 'true'`, but still contains a direct logic path; not a thin wrapper by default.
- AC3 — Self-tests: Pass. `auto-pr-self-test.yml` runs a matrix (feature, story done, story not done) in dry‑run mode.
- AC4 — Local preflight: Partial. Lint job present; dry‑run validation exists via self‑test, but no separate local preflight parser job.

Verdict: Keep `Status: InProgress`. Progress made; finalize thin wrapper and add local preflight parser job to complete.



# Story 3.1: Initiate swap (HTLC)

## Status
Review

## Dependencies

- 0.5 ICP service layer bootstrap
- 0.7 Auth skeleton (UI-only)
- 0.6 Logging & error handling baseline
- 0.8 Security baseline
- 1.1 Register with email/social
- 2.1 Create listing

## Story

As a buyer, I want to initiate an atomic swap so my payment is protected until release.

## Acceptance Criteria

1. Given listing is active, when I initiate with valid parameters, then escrow is created with timelock and hashlock. [Source: prd/4b-user-stories-and-acceptance.md#e3-atomic-swap-escrow]

### BDD Scenarios

- Scenario: Successful swap initiation
  - Given I am authenticated and viewing an active listing
  - And I have generated a secret and its hash
  - When I confirm purchase
  - Then the Atomic Swap canister creates an escrow with my buyer principal, timelock, and secretHash, and returns a swap ID

- Scenario: Price conversion check
  - Given I do not know the crypto amount for the USD price
  - When the app requests a conversion from the Price Oracle canister
  - Then the UI displays the expected crypto amount and proceeds with that amount

- Scenario: Invalid parameters
  - Given the listing is not active or I am not authenticated
  - When I attempt to initiate
  - Then the operation fails with an appropriate error, and no escrow is created

## Tasks / Subtasks

- [ ] Frontend: HTLC initiation UI (AC: 1)
  - [ ] Create `InitiateSwapScreen` with crypto amount, terms, and confirmation flow. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Add wallet integration for payment setup and HTLC parameters. [Source: architecture/core-workflows.md#htlc-atomic-swap-flow]
  - [ ] Display trade timeline and next steps to user. [Source: architecture/frontend-architecture.md#state-management-architecture]
  - [ ] **Localization: Implement multi-language support for swap terms, confirmation dialogs, transaction steps, wallet integration messages, and trade status updates.**
  - [ ] **Logging: Implement debug logging for swap initiation attempts, HTLC parameter generation, wallet integration events, timelock and hashlock setup, and transaction broadcasting. Ensure logging is disabled in production flavors and only active in development/staging builds.**

- [ ] Frontend: Service layer integration (AC: 1)
  - [ ] Use `PriceOracleService.getConversionAmount(fromUSD, symbol)` to show amount. [Source: architecture/api-specification.md#price-oracle-canister]
  - [ ] Call `AtomicSwapService.initiateSwap(listingId, secretHash, timeout)` via ICP service actor. [Source: architecture/frontend-architecture.md#frontend-services-layer]
  - [ ] Map `Result` to domain and handle errors per standards. [Source: architecture/coding-standards.md#critical-fullstack-rules]

- [ ] Backend: Atomic Swap canister supports initiation with validation (AC: 1)
  - [ ] Confirm/define `initiateSwap` Candid signature and validations. [Source: architecture/api-specification.md#icp-candid-interface]
  - [ ] Enforce authentication, ensure listing validation through Marketplace. [Source: architecture/components.md#atomic-swap-canister]

- [ ] Security: Inputs and principal protections (AC: 1)
  - [ ] Validate caller principal, secretHash format, and timeout bounds; apply rate limiting. [Source: architecture/coding-standards.md#critical-fullstack-rules]

- [ ] Testing: Unit, widget, and integration tests (AC: 1)
  - [ ] Flutter tests for flow from listing to swap initiation. [Source: architecture/testing-strategy.md#test-organization]
  - [ ] Canister unit tests for `initiateSwap` happy path and invalid inputs. [Source: architecture/testing-strategy.md#test-organization]

## Dev Notes

### Previous Story Insights

- Requires an active listing created in 2.1 and an authenticated user from 1.1. [Source: prd/4b-user-stories-and-acceptance.md#e2-listings-&-discovery] [Source: prd/4b-user-stories-and-acceptance.md#e1-user-identity]

### Data Models

- Atomic Swap attributes used: `id`, `listingId`, `buyer`, `seller`, `secretHash`, `amount`, `cryptoType`, `timeout`, `status`. [Source: architecture/data-models.md#atomic-swap-model]

### API Specifications

- Atomic Swap canister: `initiateSwap(listingId, secretHash, timeout) -> Result<Nat, Text>`. [Source: architecture/api-specification.md#icp-candid-interface]
- Price Oracle: `getConversionAmount(fromUSD, toCrypto) -> ?Nat64`. [Source: architecture/api-specification.md#price-oracle-canister]

### Component Specifications

- Frontend screen in `lib/features/trading/screens/swap_screen.dart`; provider in `lib/features/trading/providers/`. [Source: architecture/frontend-architecture.md#flutter-app-structure]
- Backend: Atomic Swap canister performs validation, creates escrow entry, and returns id. [Source: architecture/components.md#atomic-swap-canister]

### File Locations

- ICP services under `lib/core/blockchain/icp_service.dart` and dedicated services for `atomic_swap` and `price_oracle`. [Source: architecture/frontend-architecture.md#frontend-services-layer]

### Testing Requirements

- Frontend tests under `test/integration/flows/` for swap initiation; widget tests for UI prompts. Canister tests under `canisters/atomic_swap/test/`. [Source: architecture/testing-strategy.md#test-organization]

### Technical Constraints

- Follow coding standards for principal validation, result handling, immutability, and error mapping. [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Core Workflows

- Follow Atomic Swap flow including price retrieval, secret generation, and canister call. [Source: architecture/core-workflows.md#atomic-swap-flow]

### Project Structure Notes

- Treat canisters as external services in this repo; UI and service layer live under `lib/` paths per architecture. [Source: architecture/unified-project-structure.md#monorepo-structure]

## Testing

- Verify:
  - Price conversion is displayed before initiation.
  - Successful initiation returns swap ID and navigates to details.
  - Error cases: unauthenticated user, inactive listing, invalid parameters.

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft created for Story 3.1 | Scrum Master |

## Dev Agent Record

- Agent Model Used: _TBD_
- Debug Log References: _TBD_
- Completion Notes List: _TBD_
- File List: _TBD_

## QA Results

_TBD_



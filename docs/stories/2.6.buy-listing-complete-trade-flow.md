# Story 2.6: Buy listing - Complete trade initiation flow

## Status
Ready for Review

## Dependencies

- 1.1 Register with email/social
- 2.1 Create listing
- 2.2 Search and filter
- 2.3 Listing detail view
- 3.1 Initiate swap (HTLC)

## Story

As a buyer, I want to purchase a listing through a guided flow that handles price conversion, payment setup, and atomic swap initiation, so that I can complete a secure transaction with the seller.

## Acceptance Criteria

1. Given I am viewing an active listing, when I click "Buy Now", then I am guided through price conversion, payment confirmation, and atomic swap initiation. [Source: prd/4-functional-requirements.md#42-trading-functions]
2. Given the listing has a USD price, when I proceed to buy, then I see the current cryptocurrency conversion amount from the Price Oracle. [Source: architecture/core-workflows.md#atomic-swap-flow]
3. Given I confirm the purchase, when the atomic swap is initiated, then I receive a swap ID and both parties are notified of the pending transaction. [Source: architecture/core-workflows.md#atomic-swap-flow]
4. Given the swap is created, when I proceed, then I see clear next steps for payment and seller confirmation. [Source: prd/0-mvp-scope.md#05-mvp-kpis]

### BDD Scenarios

- Scenario: Successful purchase initiation
  - Given I am authenticated and viewing an active listing
  - And the Price Oracle is returning valid conversion rates
  - When I click "Buy Now" and confirm the purchase details
  - Then an atomic swap is created with proper timelock and secret hash
  - And I receive a swap ID and notification is sent to the seller
  - And I see the next steps for completing the payment

- Scenario: Price conversion validation
  - Given I am viewing a listing with USD pricing
  - When I start the purchase flow
  - Then I see the current cryptocurrency amount required
  - And I can see the conversion rate and timestamp
  - And the system warns me if the price is stale or unavailable

- Scenario: Purchase flow error handling
  - Given the Price Oracle is unavailable or the listing is no longer active
  - When I attempt to purchase
  - Then I see appropriate error messages and cannot proceed
  - And no atomic swap is created

## Tasks / Subtasks

- [ ] Frontend: Create comprehensive Buy Flow UI (AC: 1, 4)
  - [ ] Create `BuyListingScreen` with price display, conversion info, and confirmation flow. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Implement guided multi-step wizard (Price → Confirm → Payment Setup → Completion). [Source: architecture/frontend-architecture.md#state-management-architecture]
  - [ ] Add loading states and error handling throughout the flow. [Source: architecture/coding-standards.md#critical-fullstack-rules]
  - [ ] **Localization: Implement multi-language support for purchase flow steps, price displays, confirmation dialogs, error messages, and success notifications.**
  - [ ] **Logging: Implement debug logging for purchase flow initiation, price oracle queries, swap creation events, payment confirmation steps, and transaction status updates. Ensure logging is disabled in production flavors and only active in development/staging builds.**

- [ ] Frontend: Price Oracle Integration (AC: 2)
  - [ ] Call `PriceOracleService.getConversionAmount(priceUSD, cryptoType)` for real-time conversion. [Source: architecture/api-specification.md#price-oracle-canister]
  - [ ] Display conversion rate, timestamp, and staleness warnings. [Source: architecture/core-workflows.md#atomic-swap-flow]
  - [ ] Handle price oracle failures gracefully with retry mechanisms. [Source: architecture/coding-standards.md#error-handling]

- [ ] Frontend: Atomic Swap Integration (AC: 3)
  - [ ] Generate cryptographically secure secret and hash for HTLC. [Source: architecture/data-models.md#atomic-swap-model]
  - [ ] Call `AtomicSwapService.initiateSwap(listingId, secretHash, timeout)` through ICP service layer. [Source: architecture/frontend-architecture.md#frontend-services-layer]
  - [ ] Handle swap creation success/failure and update UI accordingly. [Source: architecture/core-workflows.md#atomic-swap-flow]

- [ ] Frontend: State Management and Navigation (AC: 4)
  - [ ] Implement `BuyFlowProvider` with Bloc/Cubit for complex state management. [Source: architecture/frontend-architecture.md#state-management-architecture]
  - [ ] Navigate to trade tracking screen after successful swap creation. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Persist trade state and handle app restarts during purchase flow. [Source: architecture/frontend-architecture.md#state-management-architecture]

- [ ] Backend: Validate swap initiation requirements (AC: 3)
  - [ ] Ensure Atomic Swap canister validates listing status and buyer authentication. [Source: architecture/api-specification.md#atomic-swap-canister]
  - [ ] Verify timeout values are within acceptable ranges for MVP. [Source: prd/0-mvp-scope.md#05-mvp-kpis]

- [ ] Integration: Notification System (AC: 3)
  - [ ] Trigger seller notification when swap is created. [Source: architecture/core-workflows.md#atomic-swap-flow]
  - [ ] Send buyer confirmation with swap details and next steps. [Source: architecture/frontend-architecture.md#flutter-app-structure]

## Dev Notes

### Previous Story Insights
- Story 1.1 established user authentication and ICP principal mapping
- Story 2.1-2.3 created the listing ecosystem and discovery
- Story 3.1 defined atomic swap initiation but lacks comprehensive buyer UX integration

### Data Models [Source: architecture/data-models.md]
**Atomic Swap Model:**
```typescript
interface AtomicSwap {
  id: number;
  listingId: number;
  buyer: Principal;
  seller: Principal;
  secretHash: number[];
  amount: bigint;
  cryptoType: string;
  timeout: bigint;
  status: 'pending' | 'completed' | 'refunded' | 'expired';
  createdAt: bigint;
}
```

**Listing Model Status:** Must be 'active' for purchase initiation

### API Specifications [Source: architecture/api-specification.md]
**Price Oracle Canister:**
- `getConversionAmount(priceUSD: Nat64, cryptoType: Text) -> Result<ConversionResponse, PriceError>`
- Handle staleness checks and conversion rate validation

**Atomic Swap Canister:**
- `initiateSwap(listingId: Nat, secretHash: [Nat8], timeout: Int) -> Result<SwapResponse, SwapError>`
- Returns swap ID and creation timestamp

### Component Specifications [Source: architecture/frontend-architecture.md]
**File Locations:**
- Main screen: `lib/features/marketplace/screens/buy_listing_screen.dart`
- State management: `lib/features/marketplace/providers/buy_flow_provider.dart`
- Widgets: `lib/features/marketplace/widgets/price_conversion_widget.dart`
- Services: `lib/core/blockchain/price_oracle_service.dart`

**State Management Architecture:**
- Use Bloc/Cubit pattern for complex purchase flow state
- Persist critical state (swap ID, secrets) securely during flow
- Handle navigation state and deep linking to trade tracking

### Testing Requirements [Source: architecture/testing-strategy.md]
**Unit Tests:**
- Price conversion logic and error handling
- Secret generation and validation
- State management transitions

**Widget Tests:**
- Purchase flow UI components
- Loading and error states
- Multi-step wizard navigation

**Integration Tests:**
- End-to-end purchase flow from listing to swap creation
- Price Oracle integration with various scenarios
- Error handling across service boundaries

### Technical Constraints [Source: architecture/coding-standards.md]
- All external service calls must use Result<T, Error> pattern
- Implement proper loading states for async operations
- Validate all user inputs before service calls
- Use secure storage for sensitive data (secrets, swap details)
- Follow Flutter best practices for complex navigation flows

### Security Considerations [Source: architecture/coding-standards.md#security-requirements]
- Generate cryptographically secure secrets using platform secure random
- Never log or expose secrets in plain text
- Validate all conversion amounts and rates before proceeding
- Implement proper timeout handling for atomic swaps
- Ensure proper principal validation for buyer authentication

## Testing

### Unit Testing
- Test price conversion calculations and formatting
- Test secret generation and hash creation
- Test error handling for various failure scenarios
- Test state management transitions and persistence

### Widget Testing  
- Test BuyListingScreen UI components and interactions
- Test multi-step wizard flow and navigation
- Test loading states and error displays
- Test accessibility and localization

### Integration Testing
- Test complete purchase flow from listing view to swap creation
- Test Price Oracle service integration and error handling
- Test Atomic Swap service integration and response handling
- Test notification system integration

### Performance Testing
- Measure page load times for purchase flow
- Test memory usage during complex state transitions
- Validate smooth animations and transitions

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | 1.0 | Initial story creation with comprehensive buy flow requirements | SM |
| 2025-08-28 | 1.1 | Status updated to Ready for Review after validation - all checklist criteria passed | SM |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent during review*
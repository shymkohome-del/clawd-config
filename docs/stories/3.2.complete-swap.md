# Story 3.2: Complete swap (secret reveal)

## Status
Review

## Dependencies

- 3.1 Initiate swap (HTLC)
- 4.1 Payment method capture & confirmation

## Story

As a buyer, I want to complete the swap by revealing the secret so that funds are released and the trade closes.

## Acceptance Criteria

1. Given an active swap and seller confirmation, when I provide the correct secret, then the swap completes successfully. [Source: prd/4b-user-stories-and-acceptance.md#e3-atomic-swap-escrow]
2. Given an incorrect secret, when I attempt completion, then it fails with a clear error and remains pending. [Source: architecture/api-specification.md#atomic-swap-canister]

### BDD Scenarios

- Scenario: Successful completion
  - Given a pending swap with a known secretHash
  - And seller has marked payment received
  - When I reveal the correct secret
  - Then the canister completes the swap and returns success

- Scenario: Incorrect secret
  - Given a pending swap
  - When I enter an incorrect secret
  - Then completion fails with an error

## Tasks / Subtasks

- [ ] Frontend: Completion UI and wallet integration (AC: 1)
  - [ ] Create `CompleteSwapScreen` with secret reveal and finalization flow. [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [ ] Integrate wallet for secret submission and final transaction. [Source: architecture/core-workflows.md#htlc-atomic-swap-flow]
  - [ ] Show completion confirmation and trade success state. [Source: architecture/frontend-architecture.md#state-management-architecture]
  - [ ] **Localization: Implement multi-language support for completion steps, success confirmations, wallet transaction prompts, and final trade notifications.**
  - [ ] **Logging: Implement debug logging for swap completion attempts, secret validation events, wallet transaction submissions, completion confirmations, and trade finalization status. Ensure logging is disabled in production flavors and only active in development/staging builds.**

- [ ] Frontend: Service layer call (AC: 1)
  - [ ] Call `completeSwap(swapId, secret)` via ICP service. [Source: architecture/api-specification.md#atomic-swap-canister]

- [ ] Backend: Canister validation (AC: 1, 2)
  - [ ] Validate secret vs stored `secretHash`; update status to `#completed`. [Source: architecture/components.md#atomic-swap-canister]

- [ ] Testing (AC: 1, 2)
  - [ ] Widget tests for completion flow; canister unit tests for success/failure. [Source: architecture/testing-strategy.md#test-organization]

## Dev Notes

### Data Models & APIs

- `completeSwap(swapId, secret) -> Result<(), Text>`. [Source: architecture/api-specification.md#atomic-swap-canister]

### Structure and Workflows

- Completion follows atomic swap flow post seller confirmation. [Source: architecture/core-workflows.md#atomic-swap-flow]

## Testing

- Verify:
  - Success path updates status and UI
  - Failure path shows errors and keeps swap pending

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| YYYY-MM-DD | 0.1 | Initial draft created for Story 3.2 | Scrum Master |

## Dev Agent Record

- Agent Model Used: _TBD_
- Debug Log References: _TBD_
- Completion Notes List: _TBD_
- File List: _TBD_

## QA Results

_TBD_



# Story 1.1: Register with email/social

## Status
InProgress

## Dependencies

- 0.5 ICP service layer bootstrap
- 0.7 Auth skeleton (UI-only)
- 0.6 Logging & error handling baseline
- 0.8 Security baseline

## Story

As a new user, I want to register with email or social, so that I can access the marketplace.

## Acceptance Criteria

1. Given valid email/social, when I submit, then an account is created and I am signed in. [Source: prd/4b-user-stories-and-acceptance.md#e1-user-identity]
2. Given registration completes, when mapping occurs, then an ICP principal is associated with my account. [Source: prd/4b-user-stories-and-acceptance.md#e1-user-identity]

### BDD Scenarios

- Scenario: Successful email registration
  - Given a valid email, password, and username
  - When I submit the registration form
  - Then an account is created, I am signed in, and my ICP principal is mapped to my user profile

- Scenario: Failed registration due to invalid input or provider denial
  - Given an invalid email or OAuth provider denial
  - When I attempt to register or login via social
  - Then I see appropriate error messages and I am not signed in

## Tasks / Subtasks

- [x] Frontend: Add registration UI in `lib/features/auth/` with email/password and social login entry points (Google, etc.). (AC: 1)
  - [x] Create `RegisterScreen` with form validation (email, password, username). [Source: architecture/frontend-architecture.md#flutter-app-structure]
  - [x] Add social login buttons and initiate OAuth flow. [Source: architecture/core-workflows.md#oauth-login-flow]
  - [x] Wire state management with Bloc/Cubit for auth flow. [Source: architecture/frontend-architecture.md#state-management-architecture]
  - [x] **Localization: Implement multi-language support for registration form labels, validation messages, error states, and success messages using Flutter's internationalization (i18n) framework.**

- [x] Frontend: Integrate with User Management canister for `register` and `loginWithOAuth`. (AC: 1, 2)
  - [x] Define client calls in ICP service layer for user management actor. [Source: architecture/frontend-architecture.md#frontend-services-layer]
  - [x] Handle Result types and error states in UI. [Source: architecture/coding-standards.md#critical-fullstack-rules]
  - [x] **Localization: Ensure error messages from backend are properly localized and user-friendly across supported languages.**

- [ ] Backend: Ensure User Management canister exposes `register`, `loginWithOAuth`, and principal mapping. (AC: 2)
  - [ ] Confirm/define Candid interfaces per spec. [Source: architecture/api-specification.md#icp-candid-interface]
  - [ ] Persist user profile with principal mapping. [Source: architecture/data-models.md#user-model]

- [ ] Security: Validate inputs and enforce rate limits where applicable. (AC: 1)
  - [ ] Input validation in canister functions. [Source: architecture/coding-standards.md#critical-fullstack-rules]

- [x] Testing: Create unit/widget tests for registration flow and OAuth initiation. (AC: 1)
  - [x] Frontend unit/widget tests under `test/` per strategy. [Source: architecture/testing-strategy.md#test-organization]
  - [ ] Canister unit tests for user creation and principal mapping. [Source: architecture/testing-strategy.md#test-organization]

## Dev Notes

### Previous Story Insights

No previous stories exist. This is the first story in Epic 1. [Source: prd/4a-epics-and-capabilities.md#epic-e1-user-identity]

### Data Models

- User model fields required for this story include `id: Principal`, `username`, `email`, `authProvider`, `reputation`, `createdAt`, `lastLogin`, `isActive`, `kycVerified`, `profileImage?`. The critical linkage is principal mapping upon registration/login. [Source: architecture/data-models.md#user-model]

### API Specifications

- User Management Canister interfaces: `register(email, password, username) -> Result<User, Text>`, `loginWithOAuth(provider, token) -> Result<User, Text>`, `getUserProfile(user: Principal) -> ?User`. Principal mapping must be present in returned `User`. [Source: architecture/api-specification.md#icp-candid-interface]

### Component Specifications

- UI: `RegisterScreen` and optional social login entry on `LoginScreen` within `lib/features/auth/screens/`. Shared widgets under `lib/shared/widgets/` can be used for inputs and error display. [Source: architecture/frontend-architecture.md#flutter-app-structure]
- Backend: User Management Canister implements registration, OAuth login, and principal mapping. [Source: architecture/components.md#user-management-canister]

### File Locations

- Frontend app structure places auth screens under `lib/features/auth/screens/` with providers in `lib/features/auth/providers/`. Service calls via `lib/core/blockchain/icp_service.dart` (or equivalent ICP service layer). [Source: architecture/frontend-architecture.md#flutter-app-structure]

### Testing Requirements

- Organize Flutter tests under `test/unit` for form validation and `test/integration/screens` for registration flow. Implement example patterns shown in the strategy doc. [Source: architecture/testing-strategy.md#test-organization]
- Add canister unit tests for user creation and principal mapping in `canisters/user_management/test/`. [Source: architecture/testing-strategy.md#test-organization]

### Technical Constraints

- Follow tech stack versions: Dart 3.4+, Flutter 3.22+, flutter_bloc 8.x. [Source: architecture/tech-stack.md#technology-stack-table]
- Enforce coding standards: never mutate state directly; handle Result types; validate inputs; validate caller principal in canister functions. [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Core Workflows

- Registration flow sequence and OAuth flow must match documented steps, including principal mapping and returning user profile. [Source: architecture/core-workflows.md#user-registration-flow] [Source: architecture/core-workflows.md#oauth-login-flow]

### Project Structure Notes

- The architecture’s unified monorepo structure references `apps/mobile` and `canisters/*`, whereas this repository currently contains a single Flutter app under `lib/` and no canister code. Align paths for Flutter features as above. Canister interfaces are treated as external services per current repo; integration via ICP service layer should abstract canister calls. [Source: architecture/unified-project-structure.md#monorepo-structure]

## Testing
Review
- Unit/widget tests verifying:
  - [x] **Localization: Implement multi-language support for registration form labels, validation messages, error states, and success messages using Flutter's internationalization (i18n) framework.**
  - OAuth initiation triggers provider flow and handles success/failure.
  - Error states rendered for invalid inputs and backend errors.

## Change Log

| 2025-08-26 | 0.5 | Completed localization subtasks; verified localized error mapping; formatted code; analyzer/tests PASS; backend principal mapping pending → Status remains InProgress | Dev |
| 2025-08-25 | 0.3 | Implemented i18n for Register UI (EN/LV), added runtime locale switch with persistence; analyzer/tests PASS; set Status to Review | Dev |
| Date | Version | Description | Author |
  - Added localization (ARB files, delegates), localized Register UI, and runtime language switch with SharedPreferences persistence.
| YYYY-MM-DD | 0.1 | Initial draft created for Story 1.1 | Scrum Master |
  - lib/core/config/app_config.dart (config loader)
  - lib/main.dart (provide AuthService, localization wiring, language menu)
  - lib/l10n/app_en.arb (new)
  - lib/l10n/app_lv.arb (new)
  - lib/core/i18n/locale_controller.dart (new)
| 2025-08-25 | 0.4 | QA review: AC1 Pass, AC2 Fail — no principal mapping/backend implementation; Status returned to InProgress; added QA Results details | QA |
## Dev Agent Record
  - Implemented RegisterScreen with validation and Google/Apple OAuth buttons.
  - Introduced AuthService abstraction for testability; provided concrete AuthServiceProvider.
  - Wired AuthCubit and result/error handling; navigation to Home on success.
  - Added unit, widget, and integration tests for registration and OAuth initiation.
  - Added localization (ARB files, delegates), localized Register UI, and runtime language switch with SharedPreferences persistence.
- Completion Notes List:
  - Implemented RegisterScreen with validation and Google/Apple OAuth buttons.
  - Introduced AuthService abstraction for testability; provided concrete AuthServiceProvider.
  - Wired AuthCubit and result/error handling; navigation to Home on success.
  - Added unit, widget, and integration tests for registration and OAuth initiation.
- File List:
  - lib/features/auth/cubit/auth_cubit.dart (updated to use AuthService)
  - lib/features/auth/cubit/auth_state.dart (existing)
  - lib/features/auth/providers/auth_service_provider.dart (added AuthService interface)
  - lib/features/auth/screens/register_screen.dart (UI + Apple button + DI override)
  - lib/core/blockchain/icp_service.dart (stubs used)
  - lib/core/blockchain/errors.dart (Result/AuthError)
  - lib/core/config/app_config.dart (config loader)
  - lib/main.dart (provide AuthService)
  - test/unit/auth_cubit_test.dart (new)
  - test/unit/app_config_test.dart (existing)
  - test/widget/register_screen_test.dart (new)
  - test/integration/screens/register_screen_integration_test.dart (new)

## QA Results
Acceptance review (2025-08-25):
- AC1 — Pass: Email and social (Google/Apple) flows create an account and sign in, navigating to Home on success. Evidence: `RegisterScreen` listener routes on `AuthSuccess`; `ICPService.register/loginWithOAuth` return success; unit/widget/integration tests cover submit, progress state, navigation, and OAuth initiation.
- AC2 — Fail: Principal mapping is not implemented. No backend canister code exists; `ICPService` stubs don’t perform mapping or return a `User` with principal; no tests assert mapping after registration/login.


